ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 10.1 La rÃ©plication Master-Replica : Principes et latence

## Introduction

La rÃ©plication Master-Replica (anciennement Master-Slave) est le mÃ©canisme fondamental permettant la haute disponibilitÃ© et la scalabilitÃ© en lecture dans Redis. Contrairement aux bases de donnÃ©es relationnelles traditionnelles, la rÃ©plication Redis est **asynchrone par dÃ©faut**, optimisÃ©e pour la performance au dÃ©triment de la cohÃ©rence forte.

### Objectifs de cette section

- Comprendre les mÃ©canismes internes de la rÃ©plication
- MaÃ®triser les diffÃ©rentes phases de synchronisation
- Analyser et optimiser la latence de rÃ©plication
- Configurer une rÃ©plication robuste en production
- Diagnostiquer et rÃ©soudre les problÃ¨mes de rÃ©plication

---

## ğŸ—ï¸ Architecture de la rÃ©plication

### Vue d'ensemble

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHITECTURE MASTER-REPLICA                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚   APPLICATION   â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                    â”‚
â”‚           â”‚ Writes (SET, INCR, LPUSH, etc.)                    â”‚
â”‚           â”‚ + Reads                                            â”‚
â”‚           â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚                 â”‚                                           â”‚
â”‚  â”‚  REDIS MASTER   â”‚                                           â”‚
â”‚  â”‚   (Read/Write)  â”‚                                           â”‚
â”‚  â”‚                 â”‚                                           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                           â”‚
â”‚  â”‚  â”‚ Repl      â”‚  â”‚                                           â”‚
â”‚  â”‚  â”‚ Backlog   â”‚  â”‚â—„â”€â”€â”€ Buffer circulaire (1MB par dÃ©faut)    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                           â”‚
â”‚  â”‚                 â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                    â”‚
â”‚           â”‚ Replication Stream                                 â”‚
â”‚           â”‚ (commandes Ã©crites)                                â”‚
â”‚           â”‚                                                    â”‚
â”‚           â”‚                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚    â”‚              â”‚                 â”‚                          â”‚
â”‚    â–¼              â–¼                 â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ REPLICA1 â”‚  â”‚ REPLICA2 â”‚  â”‚ REPLICA3 â”‚                      â”‚
â”‚  â”‚  (Read)  â”‚  â”‚  (Read)  â”‚  â”‚  (Read)  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                      â”‚
â”‚        â”‚             â”‚             â”‚                           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                      â”‚                                         â”‚
â”‚              Read-only queries                                 â”‚
â”‚              (load balanced)                                   â”‚
â”‚                      â”‚                                         â”‚
â”‚                      â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚              â”‚   CLIENTS  â”‚                                    â”‚
â”‚              â”‚   (Reads)  â”‚                                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CaractÃ©ristiques:
â€¢ RÃ©plication unidirectionnelle (Master â†’ Replica)
â€¢ Asynchrone et non-blocking
â€¢ Replicas en read-only par dÃ©faut
â€¢ Multiple replicas supportÃ©s (fan-out)
â€¢ Pas de limite thÃ©orique au nombre de replicas
```

### Flux de donnÃ©es

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLUX DE COMMANDES WRITE                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚
â”‚                                                                â”‚
â”‚  t0: Client Write                                              â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚  â”‚ SET foo â”‚â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  "bar"  â”‚       â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                                           â”‚
â”‚                    â”‚                                           â”‚
â”‚  t1: Master Process                                            â”‚
â”‚      â”‚             â–¼                                           â”‚
â”‚      â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚      â”‚      â”‚   MASTER    â”‚                                    â”‚
â”‚      â”‚      â”‚   Memory    â”‚                                    â”‚
â”‚      â”‚      â”‚ foo = "bar" â”‚                                    â”‚
â”‚      â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚      â”‚             â”‚                                           â”‚
â”‚      â”‚             â”‚ Propagate to replicas                     â”‚
â”‚      â”‚             â”‚                                           â”‚
â”‚      â–¼             â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚   ACK   â”‚  â”‚ Replication â”‚                                  â”‚
â”‚  â”‚  Client â”‚  â”‚   Backlog   â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                      â”‚                                         â”‚
â”‚  t2: Network Transfer (latency)                                â”‚
â”‚                      â”‚                                         â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                â”‚           â”‚        â”‚                          â”‚
â”‚                â–¼           â–¼        â–¼                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚ REPLICA1 â”‚ â”‚ REPLICA2 â”‚ â”‚ REPLICA3 â”‚                 â”‚
â”‚         â”‚          â”‚ â”‚          â”‚ â”‚          â”‚                 â”‚
â”‚  t3:    â”‚  Apply   â”‚ â”‚  Apply   â”‚ â”‚  Apply   â”‚                 â”‚
â”‚         â”‚ foo="bar"â”‚ â”‚ foo="bar"â”‚ â”‚ foo="bar"â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚              â”‚            â”‚            â”‚                       â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                           â”‚                                    â”‚
â”‚  t4: Eventual Consistency Achieved                             â”‚
â”‚                                                                â”‚
â”‚  Î”t (replication lag) = t3 - t1                                â”‚
â”‚  Typical values: 1-10ms (same DC), 50-200ms (cross-DC)         â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Les trois phases de la rÃ©plication

### Phase 1 : Connexion et Handshake

Lorsqu'un replica se connecte Ã  un master pour la premiÃ¨re fois :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: HANDSHAKE INITIAL                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  REPLICA                          MASTER                        â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚  1. TCP Connection             â”‚                           â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚  2. PING                       â”‚                           â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
â”‚    â”‚         â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ PONG                      â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚  3. AUTH <password>            â”‚                           â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ (si requirepass activÃ©)   â”‚
â”‚    â”‚         â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ +OK                       â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚  4. REPLCONF listening-port    â”‚                           â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
â”‚    â”‚         â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ +OK                       â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚  5. REPLCONF capa eof psync2   â”‚                           â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ (capacitÃ©s protocole)     â”‚
â”‚    â”‚         â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ +OK                       â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚  6. PSYNC <runid> <offset>     â”‚                           â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ (demande synchronisation) â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚       DÃ©cision du Master       â”‚                           â”‚
â”‚    â”‚                                â”‚                           â”‚
â”‚    â”‚         FULLRESYNC             â”‚  CONTINUE                 â”‚
â”‚    â”‚    (nouvelle connexion)        â”‚  (resync partielle)       â”‚
â”‚    â”‚                                â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Commandes Ã©changÃ©es** :

```bash
# Sur le replica (logs)
Connecting to MASTER 10.0.1.10:6379
MASTER <-> REPLICA sync started
Non blocking connect for SYNC fired the event.
Master replied to PING, replication can continue...
Partial resynchronization not possible (no cached master)
Full resync from master: <runid>:<offset>
```

### Phase 2 : Full Resynchronization (PSYNC)

Lors de la premiÃ¨re synchronisation ou aprÃ¨s une dÃ©connexion prolongÃ©e :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: FULL RESYNC (Disk-based)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  MASTER                                                        â”‚
â”‚    â”‚                                                           â”‚
â”‚    â”‚ 1. Fork() process                                         â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚    â”‚            â”‚                                              â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚    â”‚    â”‚  Child Process â”‚                                     â”‚
â”‚    â”‚    â”‚  (RDB dump)    â”‚                                     â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚    â”‚            â”‚                                              â”‚
â”‚    â”‚            â”‚ Write to disk                                â”‚
â”‚    â”‚            â–¼                                              â”‚
â”‚    â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚    â”‚       â”‚ RDB     â”‚                                         â”‚
â”‚    â”‚       â”‚ File    â”‚                                         â”‚
â”‚    â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                         â”‚
â”‚    â”‚            â”‚                                              â”‚
â”‚    â”‚ 2. Buffer new writes during dump                          â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚    â”‚    â”‚ Replication    â”‚                                     â”‚
â”‚    â”‚    â”‚ Backlog        â”‚â—„â”€â”€â”€ Nouvelles commandes             â”‚
â”‚    â”‚    â”‚ (circular buf) â”‚                                     â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚    â”‚            â”‚                                              â”‚
â”‚    â”‚ 3. Send RDB file                                          â”‚
â”‚    â”‚            â”‚                                              â”‚
â”‚    â”‚            â–¼                                              â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ REPLICA                       â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚                             â”‚ 4. Load RDB                 â”‚
â”‚    â”‚                             â”‚    into memory              â”‚
â”‚    â”‚                             â–¼                             â”‚
â”‚    â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚    â”‚                        â”‚ Dataset â”‚                        â”‚
â”‚    â”‚                        â”‚ Loaded  â”‚                        â”‚
â”‚    â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                        â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚ 5. Stream backlog           â”‚                             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
â”‚    â”‚    (commands since fork)    â”‚ Apply commands              â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚ 6. Normal replication       â”‚                             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
â”‚    â”‚    (ongoing)                â”‚                             â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DurÃ©e typique:
â€¢ Dataset 1GB: 5-15 secondes
â€¢ Dataset 10GB: 30-90 secondes
â€¢ Dataset 50GB: 2-5 minutes

Impact:
â€¢ CPU spike sur master (fork)
â€¢ RÃ©seau saturÃ© (transfer)
â€¢ Replica indisponible pendant le load
```

**Configuration disk-based** :

```ini
# redis.conf (Master)

# Mode de synchronisation (disk-based par dÃ©faut)
repl-diskless-sync no
repl-diskless-sync-delay 5

# Optimisation fork()
save ""  # DÃ©sactiver auto-save pendant sync si sÃ©parÃ©
```

### Phase 2 bis : Diskless Replication (RecommandÃ©)

Version optimisÃ©e sans Ã©criture disque intermÃ©diaire :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: DISKLESS RESYNC (OptimisÃ©)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  MASTER                                                        â”‚
â”‚    â”‚                                                           â”‚
â”‚    â”‚ 1. Fork() process                                         â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚    â”‚            â”‚                                              â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚    â”‚    â”‚  Child Process â”‚                                     â”‚
â”‚    â”‚    â”‚  (RDB format)  â”‚                                     â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚    â”‚            â”‚                                              â”‚
â”‚    â”‚            â”‚ Stream directly to socket                    â”‚
â”‚    â”‚            â”‚ (NO disk write)                              â”‚
â”‚    â”‚            â–¼                                              â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ REPLICA                       â”‚
â”‚    â”‚         TCP Socket          â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚                             â”‚ Receive & Load              â”‚
â”‚    â”‚                             â”‚ (streaming)                 â”‚
â”‚    â”‚                             â–¼                             â”‚
â”‚    â”‚ 2. Buffer writes       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ Dataset â”‚                        â”‚
â”‚    â”‚    â”‚Backlog   â”‚        â”‚ Loading â”‚                        â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                        â”‚
â”‚    â”‚         â”‚                   â”‚                             â”‚
â”‚    â”‚ 3. Stream backlog           â”‚                             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Avantages:
âœ… Pas d'I/O disque (plus rapide)
âœ… Ã‰conomie d'espace disque
âœ… Moins de latence
âœ… Optimal pour SSD/NVMe

InconvÃ©nient:
âš ï¸  Si Ã©chec rÃ©seau, recommencer depuis le dÃ©but
```

**Configuration diskless** (recommandÃ©e) :

```ini
# redis.conf (Master)

# Activer diskless sync
repl-diskless-sync yes

# DÃ©lai d'attente pour autres replicas (batch sync)
# Si plusieurs replicas se connectent, attendre 5s pour tous les syncer ensemble
repl-diskless-sync-delay 5

# Redis 7.0+: Attente max pour replicas supplÃ©mentaires
repl-diskless-sync-max-replicas 3
```

### Phase 3 : Partial Resynchronization (PSYNC2)

AprÃ¨s une dÃ©connexion brÃ¨ve, resynchronisation partielle possible :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 3: PARTIAL RESYNC (PSYNC2)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  ScÃ©nario: Replica dÃ©connectÃ©e 30 secondes                     â”‚
â”‚                                                                â”‚
â”‚  MASTER                        REPLICA                         â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  Normal replication         â”‚                             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
â”‚    â”‚  offset: 1000               â”‚ offset: 1000                â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  âœ— Network interruption     â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  Commands buffered:         â”‚                             â”‚
â”‚    â”‚  offset: 1001-1500          â”‚                             â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                             â”‚
â”‚    â”‚  â”‚ Repl       â”‚             â”‚                             â”‚
â”‚    â”‚  â”‚ Backlog    â”‚             â”‚                             â”‚
â”‚    â”‚  â”‚ [1001-1500]â”‚             â”‚                             â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  âœ“ Network restored         â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚    â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ PSYNC <runid> 1000          â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  Check backlog:             â”‚                             â”‚
â”‚    â”‚  1000 still in buffer? YES  â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ +CONTINUE                   â”‚
â”‚    â”‚  Send only [1001-1500]      â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Apply missing commands      â”‚
â”‚    â”‚                             â”‚ offset: 1000â†’1500           â”‚
â”‚    â”‚                             â”‚                             â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Normal replication resume   â”‚
â”‚    â”‚  offset: 1501+              â”‚                             â”‚
â”‚    â”‚                             â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Conditions pour PSYNC:
âœ… runid du master identique (pas de restart)
âœ… offset dans le backlog
âœ… Pas de timeout expirÃ©

Sinon â†’ FULLRESYNC
```

**Configuration du backlog** :

```ini
# redis.conf (Master)

# Taille du backlog (dÃ©faut: 1MB, production: 64-256MB)
repl-backlog-size 128mb

# TTL du backlog aprÃ¨s dÃ©connexion de tous les replicas
# AprÃ¨s ce dÃ©lai, le backlog est libÃ©rÃ©
repl-backlog-ttl 3600  # 1 heure
```

---

## â±ï¸ Latence de rÃ©plication : Analyse approfondie

### Les composants de la latence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DÃ‰COMPOSITION DE LA LATENCE DE RÃ‰PLICATION                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Latence totale = t1 + t2 + t3 + t4 + t5                      â”‚
â”‚                                                               â”‚
â”‚  t0: Client WRITE                                             â”‚
â”‚   â”‚                                                           â”‚
â”‚   â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ t1: Master Processing              â”‚  ~0.1-1ms             â”‚
â”‚  â”‚  â€¢ Parse command                   â”‚                       â”‚
â”‚  â”‚  â€¢ Execute & update memory         â”‚                       â”‚
â”‚  â”‚  â€¢ Write to AOF (if enabled)       â”‚                       â”‚
â”‚  â”‚  â€¢ Add to replication backlog      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚               â”‚                                               â”‚
â”‚               â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ t2: Master Output Buffer           â”‚  ~0.1-5ms             â”‚
â”‚  â”‚  â€¢ Copy to socket buffer           â”‚                       â”‚
â”‚  â”‚  â€¢ OS TCP stack processing         â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚               â”‚                                               â”‚
â”‚               â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ t3: Network Transfer (RTT/2)       â”‚  ~0.5-100ms           â”‚
â”‚  â”‚  â€¢ Same DC: 0.5-2ms                â”‚                       â”‚
â”‚  â”‚  â€¢ Same Region: 2-10ms             â”‚                       â”‚
â”‚  â”‚  â€¢ Cross-Region: 50-200ms          â”‚                       â”‚
â”‚  â”‚  â€¢ Cross-Continent: 100-300ms      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚               â”‚                                               â”‚
â”‚               â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ t4: Replica Input Buffer           â”‚  ~0.1-5ms             â”‚
â”‚  â”‚  â€¢ OS receive buffer               â”‚                       â”‚
â”‚  â”‚  â€¢ Redis read from socket          â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚               â”‚                                               â”‚
â”‚               â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ t5: Replica Processing             â”‚  ~0.1-1ms             â”‚
â”‚  â”‚  â€¢ Parse replication stream        â”‚                       â”‚
â”‚  â”‚  â€¢ Execute command                 â”‚                       â”‚
â”‚  â”‚  â€¢ Write to AOF (if enabled)       â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                               â”‚
â”‚  Latence typique totale:                                      â”‚
â”‚  â€¢ Same-DC: 1-10ms                                            â”‚
â”‚  â€¢ Same-Region: 5-20ms                                        â”‚
â”‚  â€¢ Cross-Region: 50-250ms                                     â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Facteurs impactant la latence

#### 1. Latence rÃ©seau (dominant)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IMPACT DE LA TOPOLOGIE RÃ‰SEAU                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Scenario 1: Same Availability Zone                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    0.5-2ms    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Master â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Replica â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚  Latence: Excellent (1-5ms)                              â”‚
â”‚                                                          â”‚
â”‚  Scenario 2: Multi-AZ (Same Region)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Master â”‚    2-10ms     â”‚Replica â”‚                     â”‚
â”‚  â”‚  AZ-A  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  AZ-B  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚  Latence: Bon (5-20ms)                                   â”‚
â”‚                                                          â”‚
â”‚  Scenario 3: Cross-Region                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Master â”‚   50-200ms    â”‚Replica â”‚                     â”‚
â”‚  â”‚ Paris  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Frankfurt                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚  Latence: Acceptable (50-250ms)                          â”‚
â”‚                                                          â”‚
â”‚  Scenario 4: Cross-Continent                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Master â”‚  100-300ms   â”‚Replica â”‚                      â”‚
â”‚  â”‚   EU   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   US   â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚  Latence: Ã‰levÃ© (100-400ms)                              â”‚
â”‚  âš ï¸  Risque de timeout et full resync                    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. Charge du master

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IMPACT DE LA CHARGE CPU/RÃ‰SEAU                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Master CPU < 50%:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Replication lag: 1-5ms         â”‚  âœ… Optimal          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                          â”‚
â”‚  Master CPU 50-80%:                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Replication lag: 5-50ms        â”‚  âš ï¸  Monitoring      â”‚
â”‚  â”‚ Reason: Scheduling delays      â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                          â”‚
â”‚  Master CPU > 80%:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Replication lag: 50-500ms+     â”‚  âŒ Critique         â”‚
â”‚  â”‚ Reason: Event loop starvation  â”‚                      â”‚
â”‚  â”‚ Risk: Timeout & full resync    â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                          â”‚
â”‚  Master Network Saturation:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Replication lag: Unbounded     â”‚  âŒ Ã‰chec            â”‚
â”‚  â”‚ Symptom: Replica disconnect    â”‚                      â”‚
â”‚  â”‚ Action: Scale-out or optimize  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. Taille des commandes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IMPACT DE LA TAILLE DES COMMANDES                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Small commands (SET, INCR):                             â”‚
â”‚  â€¢ Size: <100 bytes                                      â”‚
â”‚  â€¢ Replication: ~1ms                                     â”‚
â”‚  â€¢ Optimal                                               â”‚
â”‚                                                          â”‚
â”‚  Medium commands (HSET with multiple fields):            â”‚
â”‚  â€¢ Size: 1-10 KB                                         â”‚
â”‚  â€¢ Replication: 1-5ms                                    â”‚
â”‚  â€¢ Good                                                  â”‚
â”‚                                                          â”‚
â”‚  Large commands (HMSET huge hash):                       â”‚
â”‚  â€¢ Size: 100 KB - 1 MB                                   â”‚
â”‚  â€¢ Replication: 10-100ms                                 â”‚
â”‚  â€¢ âš ï¸  Peut bloquer le master                            â”‚
â”‚                                                          â”‚
â”‚  Very large commands (SET big value):                    â”‚
â”‚  â€¢ Size: > 1 MB                                          â”‚
â”‚  â€¢ Replication: 100ms - several seconds                  â”‚
â”‚  â€¢ âŒ Ã€ Ã©viter absolument                                â”‚
â”‚  â€¢ Single-threaded blocking                              â”‚
â”‚                                                          â”‚
â”‚  Recommendation:                                         â”‚
â”‚  â€¢ Limiter valeurs Ã  <100KB                              â”‚
â”‚  â€¢ Utiliser HMSET/HSET incrementalement                  â”‚
â”‚  â€¢ Batch via pipeline pour petites ops                   â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. Backlog saturation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SATURATION DU REPLICATION BACKLOG                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Backlog: Circular buffer (dÃ©faut 1MB)                   â”‚
â”‚                                                          â”‚
â”‚  Normal operation:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Write rate < Network bandwidth â”‚  âœ…                  â”‚
â”‚  â”‚ Backlog usage: <50%            â”‚                      â”‚
â”‚  â”‚ No data loss on brief disconnect                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                          â”‚
â”‚  High write rate:                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Write rate â‰ˆ Network bandwidth â”‚  âš ï¸                  â”‚
â”‚  â”‚ Backlog usage: 50-90%          â”‚                      â”‚
â”‚  â”‚ Risk of overflow during lag    â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                          â”‚
â”‚  Backlog overflow:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Write rate > Network bandwidth â”‚  âŒ                  â”‚
â”‚  â”‚ Backlog usage: 100% (wrap)     â”‚                      â”‚
â”‚  â”‚ Effect: FULLRESYNC required    â”‚                      â”‚
â”‚  â”‚                                â”‚                      â”‚
â”‚  â”‚  [oldest]â”€â”€â”€â–¶[newest]          â”‚                      â”‚
â”‚  â”‚     â”‚            â”‚             â”‚                      â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                      â”‚
â”‚  â”‚         â–²                      â”‚                      â”‚
â”‚  â”‚         â”‚ Wrapped (data lost)  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                          â”‚
â”‚  Solution:                                               â”‚
â”‚  â€¢ Increase repl-backlog-size (64-256MB)                 â”‚
â”‚  â€¢ Optimize network bandwidth                            â”‚
â”‚  â€¢ Reduce write throughput (scale-out)                   â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Mesurer la latence de rÃ©plication

### MÃ©thode 1 : INFO replication

```bash
# Sur le MASTER
redis-cli INFO replication

# Output:
role:master
connected_slaves:2
slave0:ip=10.0.1.11,port=6379,state=online,offset=87234512,lag=1
slave1:ip=10.0.1.12,port=6379,state=online,offset=87234500,lag=3
master_replid:8a3b4c5d6e7f8g9h0i1j2k3l4m5n6o7p8q9r0s1t
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:87234512
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:86185937
repl_backlog_histlen:1048576
```

**InterprÃ©tation** :

- **lag** : Secondes depuis le dernier PING/commande reÃ§ue (â‰¤ 1s = normal)
- **offset** : Position dans le flux de rÃ©plication
  - Master offset: 87234512
  - Replica0 offset: 87234512 (sync parfait)
  - Replica1 offset: 87234500 (12 bytes de retard)
- **state** : online (OK) vs disconnect (KO)

### MÃ©thode 2 : ROLE command

```bash
# Sur le MASTER
redis-cli ROLE

# Output:
1) "master"
2) (integer) 87234890
3) 1) 1) "10.0.1.11"
      2) "6379"
      3) "87234890"
   2) 1) "10.0.1.12"
      2) "6379"
      3) "87234875"

# Sur le REPLICA
redis-cli ROLE

# Output:
1) "slave"
2) "10.0.1.10"        # Master IP
3) (integer) 6379      # Master port
4) "connected"         # Ã‰tat de connexion
5) (integer) 87234890  # Offset rÃ©pliquÃ©
```

### MÃ©thode 3 : Monitoring continu avec script

```bash
#!/bin/bash
# monitor-replication-lag.sh

MASTER_HOST="10.0.1.10"
MASTER_PORT="6379"
PASSWORD="your_password"

while true; do
    # RÃ©cupÃ©rer l'offset du master
    MASTER_OFFSET=$(redis-cli -h $MASTER_HOST -p $MASTER_PORT -a $PASSWORD \
        INFO replication | grep master_repl_offset | cut -d: -f2 | tr -d '\r')

    # Pour chaque replica
    redis-cli -h $MASTER_HOST -p $MASTER_PORT -a $PASSWORD INFO replication | \
    grep "slave[0-9]" | while read line; do
        REPLICA_IP=$(echo $line | cut -d, -f1 | cut -d= -f2)
        REPLICA_PORT=$(echo $line | cut -d, -f2 | cut -d= -f2)
        REPLICA_OFFSET=$(echo $line | cut -d, -f4 | cut -d= -f2)
        LAG=$(echo $line | cut -d, -f5 | cut -d= -f2)

        # Calculer le dÃ©calage en bytes
        OFFSET_DIFF=$((MASTER_OFFSET - REPLICA_OFFSET))

        echo "$(date '+%Y-%m-%d %H:%M:%S') - Replica ${REPLICA_IP}:${REPLICA_PORT}"
        echo "  Lag: ${LAG}s"
        echo "  Offset diff: ${OFFSET_DIFF} bytes"

        # Alerte si lag > 10s
        if [ "$LAG" -gt 10 ]; then
            echo "  âš ï¸  WARNING: High replication lag!"
        fi
    done

    sleep 5
done
```

### MÃ©thode 4 : Prometheus + Redis Exporter

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']  # Redis Exporter

# MÃ©triques disponibles:
# - redis_connected_slaves
# - redis_slave_repl_offset
# - redis_master_repl_offset
# - redis_replication_lag_seconds
```

**Alertes Prometheus** :

```yaml
# alerts.yml
groups:
  - name: redis_replication
    rules:
      - alert: RedisReplicationLagHigh
        expr: redis_master_repl_offset - redis_slave_repl_offset > 1000000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis replication lag is high"
          description: "Replica {{ $labels.instance }} is {{ $value }} bytes behind master"

      - alert: RedisReplicaDisconnected
        expr: redis_connected_slaves < 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis has no connected replicas"
          description: "Master {{ $labels.instance }} has 0 replicas"
```

---

## âš™ï¸ Configuration avancÃ©e

### Configuration Master optimale

```ini
# redis-master.conf - Configuration Production

################################# NETWORK ####################################

bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# Protection
protected-mode yes
requirepass "VeryStrongMasterPassword!2024"
masterauth "VeryStrongMasterPassword!2024"  # Pour failover

################################ REPLICATION #################################

# Disk vs Diskless Sync
repl-diskless-sync yes  # RecommandÃ© pour performance
repl-diskless-sync-delay 5  # Attendre 5s pour grouper les syncs
repl-diskless-sync-max-replicas 0  # Pas de limite (Redis 7.0+)

# Backlog Configuration (CRITIQUE pour PSYNC)
repl-backlog-size 256mb  # Augmenter selon le write throughput
                          # Calcul: write_rate_mb/s * max_disconnect_time_s
                          # Exemple: 10MB/s * 30s = 300MB recommandÃ©
repl-backlog-ttl 3600     # Garder 1h aprÃ¨s dÃ©connexion de tous les replicas

# Protection contre isolation
min-replicas-to-write 1   # Refuser writes si <1 replica connectÃ©
min-replicas-max-lag 10   # Refuser writes si replicas ont >10s de lag

# Replica Priority (pour Sentinel)
replica-priority 100

# Timeouts
repl-timeout 60          # Timeout pour I/O de rÃ©plication
repl-ping-replica-period 10  # Ping replicas tous les 10s

# Disable BGSAVE during replication
repl-diskless-load on-empty-db  # Redis 7.0+

################################ PERSISTENCE #################################

# RDB (pour replication initiale uniquement si diskless dÃ©sactivÃ©)
save ""  # DÃ©sactiver auto-save pour Ã©viter fork() pendant sync

# AOF (recommandÃ©)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec  # Bon compromis performance/durabilitÃ©
no-appendfsync-on-rewrite no  # Ne pas diffÃ©rer fsync pendant rewrite
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

################################# MEMORY #####################################

maxmemory 8gb  # Adapter selon disponible
maxmemory-policy allkeys-lru  # Ã‰viction LRU si mÃ©moire pleine

# Optimisation mÃ©moire
activerehashing yes
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

################################## SECURITY ##################################

# Renommer commandes dangereuses
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command CONFIG "CONFIG_SECRET_TOKEN_a8f5f167"
rename-command SHUTDOWN ""

# ACL (Redis 6+)
aclfile /etc/redis/users.acl

################################### LOGS #####################################

loglevel notice
logfile "/var/log/redis/redis-master.log"
syslog-enabled no

################################# TUNING #####################################

# Maximiser performance
hz 10  # FrÃ©quence des tÃ¢ches de fond (dÃ©faut: 10)
dynamic-hz yes

# Client output buffer (pour replicas)
client-output-buffer-limit replica 512mb 128mb 60
# Format: <hard limit> <soft limit> <soft seconds>
# Hard: dÃ©connexion immÃ©diate si dÃ©passÃ©
# Soft: dÃ©connexion si dÃ©passÃ© pendant 60s

# Slow log
slowlog-log-slower-than 10000  # 10ms
slowlog-max-len 128
```

### Configuration Replica optimale

```ini
# redis-replica.conf - Configuration Production

################################# NETWORK ####################################

bind 0.0.0.0
port 6379  # MÃªme port que master pour simplicitÃ© (change si sur mÃªme host)
tcp-backlog 511
timeout 0
tcp-keepalive 300

protected-mode yes
requirepass "StrongReplicaPassword!2024"  # DiffÃ©rent du master si exposition externe
masterauth "VeryStrongMasterPassword!2024"  # Password du master

################################ REPLICATION #################################

# Connexion au Master
replicaof 10.0.1.10 6379  # IP:PORT du master

# Comportement Replica
replica-read-only yes  # CRITIQUE: Ã©viter writes sur replica
replica-priority 100   # PrioritÃ© pour promotion (plus bas = prioritaire)
                       # Replica1: 100, Replica2: 90, Replica3: 80

# Timeouts et retry
repl-timeout 60
repl-ping-replica-period 10

# Sync Configuration
repl-diskless-load on-empty-db  # Charge directement en mÃ©moire (Redis 7.0+)
                                 # Ã‰vite Ã©criture disque intermÃ©diaire

# Backlog (mÃªme taille que master)
repl-backlog-size 256mb
repl-backlog-ttl 3600

# Comportement lors de dÃ©connexion
replica-serve-stale-data yes  # Continuer Ã  servir anciennes donnÃ©es si master down
                               # Mettre "no" si cohÃ©rence critique
replica-announce-ip 10.0.1.11  # IP publique (utile dans Docker/NAT)
replica-announce-port 6379

################################ PERSISTENCE #################################

# AOF (recommandÃ© sur replicas aussi)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# RDB (backup supplÃ©mentaire)
save 900 1
save 300 10
save 60 10000
dbfilename "dump.rdb"
dir /var/lib/redis

################################# MEMORY #####################################

maxmemory 8gb
maxmemory-policy allkeys-lru

activerehashing yes
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

################################## SECURITY ##################################

rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command CONFIG "CONFIG_SECRET_TOKEN_a8f5f167"

################################### LOGS #####################################

loglevel notice
logfile "/var/log/redis/redis-replica.log"

################################# TUNING #####################################

hz 10
dynamic-hz yes

# Output buffer (pour clients qui lisent depuis replica)
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 512mb 128mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

slowlog-log-slower-than 10000
slowlog-max-len 128
```

---

## ğŸ”§ Troubleshooting de la rÃ©plication

### ProblÃ¨me 1 : Replica constamment FULLRESYNC

**SymptÃ´mes** :

```bash
# Logs replica
MASTER <-> REPLICA sync started
Full resync from master: <runid>:<offset>
MASTER <-> REPLICA sync: receiving 2847362 bytes from master
# ... (se rÃ©pÃ¨te toutes les 5 minutes)
```

**Causes possibles** :

1. **Backlog trop petit**

   ```bash
   # VÃ©rifier sur master
   redis-cli INFO replication | grep backlog
   # repl_backlog_size:1048576  (1MB - trop petit!)
   ```

   **Solution** :
   ```ini
   # Augmenter le backlog
   repl-backlog-size 256mb
   ```

2. **Latence rÃ©seau trop Ã©levÃ©e**

   ```bash
   # Tester latence
   ping -c 100 10.0.1.11
   # Si >100ms de moyenne, problÃ¨me rÃ©seau
   ```

3. **Master surchargÃ© (CPU)**

   ```bash
   # VÃ©rifier CPU master
   redis-cli INFO | grep used_cpu
   # Si >80%, scale-out ou optimiser queries
   ```

### ProblÃ¨me 2 : Lag de rÃ©plication Ã©levÃ©

**Diagnostic** :

```bash
# Sur master
redis-cli INFO replication | grep lag
# slave0:...,lag=45  # 45 secondes de lag!

# VÃ©rifier output buffer
redis-cli CLIENT LIST | grep slave
# id=42 addr=10.0.1.11:45678 ... obl=1234567890 ...
#                                   â†‘ Output Buffer Length (bytes)
```

**Causes et solutions** :

| Cause | Diagnostic | Solution |
|-------|------------|----------|
| **Commandes lentes** | `SLOWLOG GET 10` | Optimiser queries, ajouter index |
| **Bandwidth saturÃ©** | `iftop` ou monitoring rÃ©seau | Upgrade rÃ©seau, compression |
| **Output buffer overflow** | `CLIENT LIST` â†’ obl Ã©levÃ© | Augmenter `client-output-buffer-limit` |
| **Replica CPU maxed** | `top` sur replica | Scale-up replica ou reduce read load |
| **Big keys** | `redis-cli --bigkeys` | Fragmenter grandes clÃ©s |

**Configuration output buffer** :

```ini
# redis.conf (Master)

# Format: <hard_limit> <soft_limit> <soft_seconds>
client-output-buffer-limit replica 512mb 128mb 60

# Signification:
# - Hard limit: 512MB â†’ dÃ©connexion immÃ©diate
# - Soft limit: 128MB pendant 60s â†’ dÃ©connexion
# - Si accumulation de donnÃ©es dÃ©passe ces limites â†’ FULLRESYNC
```

### ProblÃ¨me 3 : Replica dÃ©connectÃ©e ("master_link_status:down")

**VÃ©rification** :

```bash
# Sur replica
redis-cli INFO replication | grep master_link_status
# master_link_status:down  # âŒ ProblÃ¨me

redis-cli INFO replication | grep master_link_down_since_seconds
# master_link_down_since_seconds:127  # Down depuis 127s
```

**Causes** :

1. **ProblÃ¨me rÃ©seau**

   ```bash
   # Tester connectivitÃ©
   telnet 10.0.1.10 6379
   # Si Ã©chec â†’ firewall, routing, DNS
   ```

2. **Master down ou restart**

   ```bash
   # VÃ©rifier master
   redis-cli -h 10.0.1.10 -p 6379 PING
   ```

3. **ProblÃ¨me d'authentification**

   ```bash
   # Logs replica
   grep "AUTH failed" /var/log/redis/redis-replica.log
   # VÃ©rifier masterauth vs requirepass du master
   ```

4. **Timeout expirÃ©**

   ```ini
   # Augmenter timeout si cross-region
   repl-timeout 120  # 2 minutes au lieu de 60s
   ```

### ProblÃ¨me 4 : DonnÃ©es incohÃ©rentes entre master et replica

**Diagnostic** :

```bash
# Comparer les checksums
# Sur master
redis-cli DEBUG DIGEST

# Sur replica
redis-cli DEBUG DIGEST

# Si diffÃ©rents â†’ incohÃ©rence!
```

**Causes** :

1. **Replica n'est pas en read-only** (writes locaux)

   ```bash
   # VÃ©rifier
   redis-cli CONFIG GET replica-read-only
   # Doit Ãªtre "yes"
   ```

2. **Expiration TTL non rÃ©pliquÃ©e**
   - Redis rÃ©plique les expirations passives (pas les actives)
   - Peut causer incohÃ©rences temporaires

3. **Bug ou corruption**
   - Forcer re-sync complet :

   ```bash
   # Sur replica
   redis-cli REPLICAOF NO ONE  # Devenir standalone
   redis-cli FLUSHALL          # Vider (si acceptable)
   redis-cli REPLICAOF 10.0.1.10 6379  # Re-sync
   ```

---

## ğŸ“ˆ Optimisations avancÃ©es

### 1. Diskless Replication avec batching

```ini
# redis.conf (Master)

# Activer diskless
repl-diskless-sync yes

# Attendre 5 secondes pour batching
# Si plusieurs replicas se connectent simultanÃ©ment, les syncer ensemble
repl-diskless-sync-delay 5

# Redis 7.0+: nombre max de replicas Ã  attendre
repl-diskless-sync-max-replicas 3

# Avantage: 1 seul fork() au lieu de N forks pour N replicas
```

### 2. Compression de rÃ©plication (Redis Enterprise)

âš ï¸ **FonctionnalitÃ© Redis Enterprise uniquement**

```bash
# Activer compression (Redis Enterprise)
redis-cli CONFIG SET repl-diskless-sync-compression enabled

# Taux de compression typique: 60-80%
# Trade-off: CPU vs Bandwidth
```

### 3. Partial Resync optimisÃ© (PSYNC2)

**Redis 4.0+ amÃ©lioration** : PSYNC2 permet partial resync mÃªme aprÃ¨s :
- Failover (changement de master)
- Restart de replica
- Promotion de replica en master

```bash
# VÃ©rifier support PSYNC2
redis-cli INFO replication | grep master_replid2
# master_replid2:8a3b4c5d...  # Si non-zero = PSYNC2 actif
```

**Configuration** :

```ini
# Pas de config spÃ©cifique nÃ©cessaire
# PSYNC2 est activÃ© par dÃ©faut dans Redis 4.0+

# Augmenter backlog pour maximiser chances de partial resync
repl-backlog-size 256mb
repl-backlog-ttl 3600  # Conserver 1h
```

### 4. RÃ©plication multi-niveaux (cascade)

Pour rÃ©duire la charge sur le master avec nombreux replicas :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RÃ‰PLICATION EN CASCADE (3 niveaux)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚            â”‚  Master   â”‚                        â”‚
â”‚            â”‚   (L0)    â”‚                        â”‚
â”‚            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                  â”‚                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚                 â”‚                     â”‚
â”‚         â–¼                 â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚ Replica1 â”‚      â”‚ Replica2 â”‚  Level 1       â”‚
â”‚   â”‚   (L1)   â”‚      â”‚   (L1)   â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚
â”‚        â”‚                 â”‚                      â”‚
â”‚    â”Œâ”€â”€â”€â”´â”€â”€â”€â”         â”Œâ”€â”€â”€â”´â”€â”€â”€â”                  â”‚
â”‚    â”‚       â”‚         â”‚       â”‚                  â”‚
â”‚    â–¼       â–¼         â–¼       â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ R3 â”‚ â”‚ R4 â”‚   â”‚ R5 â”‚ â”‚ R6 â”‚  Level 2         â”‚
â”‚  â”‚(L2)â”‚ â”‚(L2)â”‚   â”‚(L2)â”‚ â”‚(L2)â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                 â”‚
â”‚  Avantages:                                     â”‚
â”‚  â€¢ RÃ©duit charge rÃ©seau sur master              â”‚
â”‚  â€¢ ScalabilitÃ© reads                            â”‚
â”‚                                                 â”‚
â”‚  InconvÃ©nients:                                 â”‚
â”‚  â€¢ Latence accrue (cumulative)                  â”‚
â”‚  â€¢ L2 replicas: lag = lag(L0â†’L1) + lag(L1â†’L2)   â”‚
â”‚  â€¢ ComplexitÃ© accrue                            â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Configuration Replica niveau 1** :

```ini
# Replica L1 (ex: Replica1)
replicaof 10.0.1.10 6379  # Master

# Permettre Ã  L1 d'avoir ses propres replicas
replica-read-only yes
```

**Configuration Replica niveau 2** :

```ini
# Replica L2 (ex: R3)
replicaof 10.0.1.11 6379  # Replica1 (L1)

replica-read-only yes
```

**âš ï¸ Limitation** : Latence cumulÃ©e peut atteindre 20-100ms selon topologie.

---

## ğŸ¯ Bonnes pratiques de production

### 1. Dimensionnement du backlog

**RÃ¨gle de calcul** :

```
repl-backlog-size = write_throughput (MB/s) Ã— max_disconnect_time (s) Ã— safety_factor (2)

Exemple:
- Write throughput: 10 MB/s
- Max disconnect tolÃ©rÃ©: 30s (avant full resync)
- Safety factor: 2

repl-backlog-size = 10 Ã— 30 Ã— 2 = 600 MB
```

**Configuration** :

```ini
repl-backlog-size 600mb  # Arrondi Ã  1GB pour sÃ©curitÃ©
repl-backlog-ttl 3600    # Conserver 1h aprÃ¨s dÃ©connexion
```

### 2. Protection contre master isolÃ©

```ini
# redis.conf (Master)

# Minimum de replicas connectÃ©s pour accepter writes
min-replicas-to-write 1

# Maximum de lag tolÃ©rÃ© (secondes)
min-replicas-max-lag 10

# Effet: Si <1 replica avec lag <10s, master refuse writes
# Protection contre split-brain
```

**Monitoring** :

```bash
# VÃ©rifier si master refuse writes
redis-cli INFO replication | grep min_slaves
# connected_slaves:0
# min_slaves_good:0  # âŒ Master refuse writes!
```

### 3. Monitoring continu

**MÃ©triques critiques** :

```bash
# Script de monitoring (cron tous les 1 min)
#!/bin/bash

MASTER="10.0.1.10"
THRESHOLD_LAG=10
THRESHOLD_OFFSET=10000000  # 10MB

# RÃ©cupÃ©rer infos
INFO=$(redis-cli -h $MASTER INFO replication)

CONNECTED=$(echo "$INFO" | grep connected_slaves | cut -d: -f2)
MASTER_OFFSET=$(echo "$INFO" | grep master_repl_offset | cut -d: -f2)

echo "$INFO" | grep "slave[0-9]" | while read line; do
    REPLICA_IP=$(echo $line | cut -d, -f1 | cut -d= -f2)
    OFFSET=$(echo $line | cut -d, -f4 | cut -d= -f2)
    LAG=$(echo $line | cut -d, -f5 | cut -d= -f2)

    DIFF=$((MASTER_OFFSET - OFFSET))

    # Alertes
    if [ $LAG -gt $THRESHOLD_LAG ]; then
        echo "ALERT: Replica $REPLICA_IP lag too high: ${LAG}s" | mail -s "Redis Alert" ops@company.com
    fi

    if [ $DIFF -gt $THRESHOLD_OFFSET ]; then
        echo "ALERT: Replica $REPLICA_IP offset diff: ${DIFF} bytes" | mail -s "Redis Alert" ops@company.com
    fi
done
```

### 4. Tests rÃ©guliers de failover

```bash
#!/bin/bash
# test-failover.sh - Ã€ exÃ©cuter en staging

echo "=== Test de Failover ==="

# 1. Ã‰tat initial
echo "Ã‰tat initial:"
redis-cli -h master INFO replication | grep role

# 2. Simuler panne master
echo "ArrÃªt du master..."
redis-cli -h master SHUTDOWN NOSAVE

# 3. Promouvoir replica manuellement
echo "Promotion replica..."
redis-cli -h replica1 REPLICAOF NO ONE

# 4. Reconfigurer autres replicas
redis-cli -h replica2 REPLICAOF replica1 6379

# 5. VÃ©rifier
echo "Nouvel Ã©tat:"
redis-cli -h replica1 INFO replication | grep role
redis-cli -h replica2 INFO replication | grep master_host

echo "Test terminÃ©. VÃ©rifier applications."
```

### 5. Documentation d'incident (Runbook)

```markdown
# Runbook: RÃ©plication Redis cassÃ©e

## SymptÃ´mes
- `master_link_status:down` sur replica
- Lag Ã©levÃ© (>60s)
- Logs: "MASTER <-> REPLICA sync started" en boucle

## Diagnostic rapide

1. VÃ©rifier connectivitÃ© rÃ©seau:
   ```
   telnet <master_ip> 6379
   redis-cli -h <master_ip> PING
   ```

2. VÃ©rifier authentification:
   ```
   grep masterauth /etc/redis/redis.conf
   redis-cli -h <master_ip> -a <password> PING
   ```

3. VÃ©rifier backlog:
   ```
   redis-cli -h <master_ip> INFO replication | grep backlog
   ```

## Actions correctives

### Cas 1: RÃ©seau coupÃ©
- Restaurer connectivitÃ©
- Attendre PSYNC automatique (30-60s)

### Cas 2: Backlog overflow
- Augmenter `repl-backlog-size`
- RedÃ©marrer master: `systemctl restart redis`

### Cas 3: Full resync en boucle
- VÃ©rifier logs: `tail -f /var/log/redis/redis-replica.log`
- Forcer re-sync propre:
  ```
  redis-cli -h <replica> REPLICAOF NO ONE
  redis-cli -h <replica> REPLICAOF <master_ip> 6379
  ```

## Escalade
Si problÃ¨me persiste aprÃ¨s 15 min â†’ Escalader Tier 2
Contact: ops-oncall@company.com
```

---

## ğŸ“ Points clÃ©s Ã  retenir

1. **RÃ©plication asynchrone** : Possible perte de donnÃ©es lors de failover
2. **Latence = RÃ©seau** : Principal facteur, optimiser topologie Multi-AZ
3. **Backlog dimensionnement** : `write_throughput Ã— max_disconnect Ã— 2`
4. **Diskless sync** : RecommandÃ© pour performance (Ã©vite I/O disque)
5. **PSYNC2** : Permet partial resync mÃªme aprÃ¨s failover (Redis 4.0+)
6. **Protection master** : `min-replicas-to-write` pour Ã©viter split-brain
7. **Monitoring continu** : Lag, offset, connected_slaves
8. **Tests rÃ©guliers** : Tester failover en staging

---

## ğŸ”— RÃ©fÃ©rences

- [Redis Replication Documentation](https://redis.io/docs/management/replication/)
- [PSYNC2 Specification](https://github.com/redis/redis/blob/unstable/src/replication.c)
- [Redis Protocol Specification](https://redis.io/docs/reference/protocol-spec/)

---

**Section suivante** : [10.2 Topologie de rÃ©plication (chaÃ®nÃ©e, en Ã©toile)](./02-topologie-replication.md)

â­ï¸ [Topologie de rÃ©plication (chaÃ®nÃ©e, en Ã©toile)](/10-architecture-haute-disponibilite/02-topologie-replication.md)
