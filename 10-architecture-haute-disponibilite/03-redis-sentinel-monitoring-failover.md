ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 10.3 Redis Sentinel : Monitoring et Failover automatique

## Introduction

Redis Sentinel est le systÃ¨me officiel de haute disponibilitÃ© pour Redis, offrant monitoring, notification et failover automatique. Sentinel transforme un setup Master-Replica basique en une infrastructure rÃ©siliente capable de survivre aux pannes sans intervention humaine.

**Sentinel n'est pas** :
- âŒ Un proxy Redis (les clients se connectent directement aux instances Redis)
- âŒ Un load balancer
- âŒ Un systÃ¨me de sharding (voir Redis Cluster pour cela)

**Sentinel est** :
- âœ… Un systÃ¨me de monitoring distribuÃ©
- âœ… Un systÃ¨me de notification (alertes)
- âœ… Un orchestrateur de failover automatique
- âœ… Un service discovery pour les clients

---

## ğŸ—ï¸ Architecture globale

### Vue d'ensemble du systÃ¨me

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARCHITECTURE REDIS + SENTINEL                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   APPLICATION LAYER                        â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  Client 1  â”‚   â”‚  Client 2  â”‚   â”‚  Client 3  â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                â”‚  â”‚
â”‚  â”‚         â”‚ 1. Ask Sentinel: "Who is master?"                â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
â”‚  â”‚                          â”‚                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SENTINEL LAYER (Consensus)                    â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚Sentinel 1â”‚â—„â”€â”€â”€â”€â”€â–¶â”‚Sentinel 2â”‚â—„â”€â”€â”€â”€â”€â–¶â”‚Sentinel 3â”‚        â”‚  â”‚
â”‚  â”‚  â”‚ :26379   â”‚       â”‚ :26379   â”‚       â”‚ :26379   â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚        â”‚                  â”‚                  â”‚             â”‚  â”‚
â”‚  â”‚        â”‚   Gossip Protocol (info exchange)   â”‚             â”‚  â”‚
â”‚  â”‚        â”‚                  â”‚                  â”‚             â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚                           â”‚                                â”‚  â”‚
â”‚  â”‚                           â”‚ 2. Monitor                     â”‚  â”‚
â”‚  â”‚                           â”‚    Vote on failures            â”‚  â”‚
â”‚  â”‚                           â”‚    Coordinate failover         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  REDIS DATA LAYER                          â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚
â”‚  â”‚         â”‚   MASTER   â”‚ :6379                               â”‚  â”‚
â”‚  â”‚         â”‚   (Write)  â”‚                                     â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚
â”‚  â”‚                â”‚                                           â”‚  â”‚
â”‚  â”‚                â”‚ Replication                               â”‚  â”‚
â”‚  â”‚                â”‚                                           â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚
â”‚  â”‚         â”‚             â”‚              â”‚                     â”‚  â”‚
â”‚  â”‚         â–¼             â–¼              â–¼                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚   â”‚ Replica1 â”‚  â”‚ Replica2 â”‚  â”‚ Replica3 â”‚                 â”‚  â”‚
â”‚  â”‚   â”‚  :6379   â”‚  â”‚  :6379   â”‚  â”‚  :6379   â”‚                 â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Flux de fonctionnement:                                         â”‚
â”‚  1. Clients interrogent Sentinels pour trouver le master         â”‚
â”‚  2. Sentinels surveillent en permanence le master et replicas    â”‚
â”‚  3. Si master down: vote et failover automatique                 â”‚
â”‚  4. Clients sont notifiÃ©s du nouveau master                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Composants et responsabilitÃ©s

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPOSANTS SENTINEL                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. MONITORING                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ â€¢ Ping master/replicas toutes les 1s â”‚                       â”‚
â”‚  â”‚ â€¢ VÃ©rifier replication lag           â”‚                       â”‚
â”‚  â”‚ â€¢ DÃ©tecter connexions/dÃ©connexions   â”‚                       â”‚
â”‚  â”‚ â€¢ Communiquer avec autres Sentinels  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚  2. NOTIFICATION                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ â€¢ Pub/Sub: Ã‰tat changements          â”‚                       â”‚
â”‚  â”‚ â€¢ Scripts: Alertes externes          â”‚                       â”‚
â”‚  â”‚ â€¢ Logs: Ã‰vÃ©nements dÃ©taillÃ©s         â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚  3. AUTOMATIC FAILOVER                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ â€¢ DÃ©tecter master down               â”‚                       â”‚
â”‚  â”‚ â€¢ Vote avec quorum                   â”‚                       â”‚
â”‚  â”‚ â€¢ Promouvoir replica â†’ master        â”‚                       â”‚
â”‚  â”‚ â€¢ Reconfigurer autres replicas       â”‚                       â”‚
â”‚  â”‚ â€¢ Notifier clients                   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚  4. CONFIGURATION PROVIDER (Service Discovery)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ â€¢ API: Qui est le master actuel?     â”‚                       â”‚
â”‚  â”‚ â€¢ RÃ©pondre aux clients               â”‚                       â”‚
â”‚  â”‚ â€¢ Fournir liste des replicas         â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” MÃ©canismes de Monitoring

### Processus de surveillance continue

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CYCLE DE MONITORING SENTINEL (1 seconde)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  t=0s: Sentinel envoie PING                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚  â”‚ Sentinel â”‚                                                   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”‚ PING                                                    â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚       â”‚                                    â”‚                    â”‚
â”‚       â–¼                                    â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Master  â”‚                         â”‚ Replica  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                   â”‚                     â”‚
â”‚       â”‚ PONG                              â”‚ PONG                â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                    â”‚                                            â”‚
â”‚  t+RTT: RÃ©ponse    â–¼                                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚              â”‚ Sentinel â”‚                                       â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â”‚ Analyse:                                   â”‚
â”‚                    â”‚ â€¢ PONG reÃ§u? â†’ Instance UP                 â”‚
â”‚                    â”‚ â€¢ Timeout? â†’ Marquer SUBJECTIVELY DOWN     â”‚
â”‚                    â”‚ â€¢ Check lag replication                    â”‚
â”‚                    â”‚                                            â”‚
â”‚  t=1s: Prochain cycle                                           â”‚
â”‚                                                                 â”‚
â”‚  ParamÃ¨tres configurables:                                      â”‚
â”‚  â€¢ down-after-milliseconds: 30000 (30s par dÃ©faut)              â”‚
â”‚  â€¢ sentinel-ping-period: 1000ms (1s, non configurable)          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ã‰tats de disponibilitÃ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TATS D'UNE INSTANCE REDIS VUE PAR SENTINEL                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. NORMAL STATE (OK)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Status: UP                           â”‚                       â”‚
â”‚  â”‚ PING response: <1s                   â”‚                       â”‚
â”‚  â”‚ Flags: master                        â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”‚ No PONG received                                      â”‚
â”‚         â”‚ for > down-after-milliseconds                         â”‚
â”‚         â–¼                                                       â”‚
â”‚                                                                 â”‚
â”‚  2. SUBJECTIVELY DOWN (SDOWN)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Status: SDOWN                        â”‚                       â”‚
â”‚  â”‚ Detected by: Ce Sentinel uniquement  â”‚                       â”‚
â”‚  â”‚ Action: Demander avis autres Sentinels                       â”‚
â”‚  â”‚ Flags: master,s_down                 â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”‚ Quorum de Sentinels d'accord                          â”‚
â”‚         â”‚ (â‰¥ sentinel quorum configured)                        â”‚
â”‚         â–¼                                                       â”‚
â”‚                                                                 â”‚
â”‚  3. OBJECTIVELY DOWN (ODOWN)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Status: ODOWN                        â”‚                       â”‚
â”‚  â”‚ Confirmed by: Quorum de Sentinels    â”‚                       â”‚
â”‚  â”‚ Action: DÃ©clencher failover          â”‚                       â”‚
â”‚  â”‚ Flags: master,o_down                 â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”‚ Failover process                                      â”‚
â”‚         â–¼                                                       â”‚
â”‚                                                                 â”‚
â”‚  4. FAILOVER IN PROGRESS                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Status: FAILOVER                     â”‚                       â”‚
â”‚  â”‚ Actions:                             â”‚                       â”‚
â”‚  â”‚ â€¢ Ã‰lire replica                      â”‚                       â”‚
â”‚  â”‚ â€¢ Promouvoir en master               â”‚                       â”‚
â”‚  â”‚ â€¢ Reconfigurer autres replicas       â”‚                       â”‚
â”‚  â”‚ Flags: master,failover_in_progress   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚  Notes importantes:                                             â”‚
â”‚  â€¢ SDOWN: Opinion subjective d'un Sentinel                      â”‚
â”‚  â€¢ ODOWN: Consensus objectif (quorum atteint)                   â”‚
â”‚  â€¢ Seul ODOWN dÃ©clenche le failover                             â”‚
â”‚  â€¢ Replicas peuvent Ãªtre SDOWN sans dÃ©clencher failover         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Communication inter-Sentinels

Les Sentinels communiquent via deux canaux :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CANAUX DE COMMUNICATION SENTINEL                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Canal 1: REDIS PUB/SUB (__sentinel__:hello)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  Sentinel 1 â”€â”€PUBLISHâ”€â”€â–¶ Master â—€â”€â”€SUBSCRIBEâ”€â”€ Sentinel 2  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  Message format (tous les 2s):                             â”‚  â”‚
â”‚  â”‚  {                                                         â”‚  â”‚
â”‚  â”‚    "sentinel_ip": "10.0.1.20",                             â”‚  â”‚
â”‚  â”‚    "sentinel_port": "26379",                               â”‚  â”‚
â”‚  â”‚    "runid": "abc123...",                                   â”‚  â”‚
â”‚  â”‚    "epoch": "0",                                           â”‚  â”‚
â”‚  â”‚    "master_name": "mymaster",                              â”‚  â”‚
â”‚  â”‚    "master_ip": "10.0.1.10",                               â”‚  â”‚
â”‚  â”‚    "master_port": "6379"                                   â”‚  â”‚
â”‚  â”‚  }                                                         â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  Permet:                                                   â”‚  â”‚
â”‚  â”‚  â€¢ Auto-dÃ©couverte des Sentinels                           â”‚  â”‚
â”‚  â”‚  â€¢ Partage de configuration                                â”‚  â”‚
â”‚  â”‚  â€¢ DÃ©tection des changements de master                     â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Canal 2: CONNEXIONS DIRECTES (ask + vote)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  Sentinel 1 â”€â”€â”€â”€TCP:26379â”€â”€â”€â”€â–¶ Sentinel 2                  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  Commandes:                                                â”‚  â”‚
â”‚  â”‚  â€¢ SENTINEL is-master-down-by-addr                         â”‚  â”‚
â”‚  â”‚    â†’ Demander si autre Sentinel voit master down           â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â€¢ SENTINEL failover-auth-request                          â”‚  â”‚
â”‚  â”‚    â†’ Demander autorisation de faire failover               â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  Response:                                                 â”‚  â”‚
â”‚  â”‚  1) (integer) 1      â† Master is down (0 = up)             â”‚  â”‚
â”‚  â”‚  2) (nil)            â† Leader runid (pendant Ã©lection)     â”‚  â”‚
â”‚  â”‚  3) (integer) 0      â† Epoch actuel                        â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ Processus de Failover automatique

### Vue d'ensemble du failover

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROCESSUS COMPLET DE FAILOVER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  PHASE 1: DÃ‰TECTION (Detection)                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚
â”‚                                                                 â”‚
â”‚  t=0: Master fonctionne normalement                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚Sentinelâ”‚      â”‚Sentinelâ”‚      â”‚Sentinelâ”‚                     â”‚
â”‚  â”‚   1    â”‚      â”‚   2    â”‚      â”‚   3    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â”‚
â”‚      â”‚ PING          â”‚ PING          â”‚ PING                     â”‚
â”‚      â–¼               â–¼               â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚ Master  â”‚ âœ… PONG                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚                                                                 â”‚
â”‚  t=30s: Master crash                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚Sentinelâ”‚      â”‚Sentinelâ”‚      â”‚Sentinelâ”‚                     â”‚
â”‚  â”‚   1    â”‚      â”‚   2    â”‚      â”‚   3    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â”‚
â”‚      â”‚ PING          â”‚ PING          â”‚ PING                     â”‚
â”‚      â–¼               â–¼               â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚ Master  â”‚ âœ— NO RESPONSE                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚                                                                 â”‚
â”‚  t=60s: SDOWN dÃ©clarÃ© par chaque Sentinel                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚Sentinelâ”‚      â”‚Sentinelâ”‚      â”‚Sentinelâ”‚                     â”‚
â”‚  â”‚   1    â”‚      â”‚   2    â”‚      â”‚   3    â”‚                     â”‚
â”‚  â”‚ SDOWN  â”‚      â”‚ SDOWN  â”‚      â”‚ SDOWN  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  PHASE 2: CONSENSUS (Agreement)                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚
â”‚                                                                 â”‚
â”‚  t=61s: Sentinels se consultent                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚Sentinelâ”‚                                                     â”‚
â”‚  â”‚   1    â”‚â”€â”€"is-master-down?"â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚Sentinelâ”‚                    â”‚
â”‚      â–²                            â”‚   2    â”‚                    â”‚
â”‚      â”‚                            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                    â”‚
â”‚      â”‚                                 â”‚                        â”‚
â”‚      â”‚   "YES, down"                   â”‚ "is-master-down?"      â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                        â–¼            â”‚           â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚           â”‚
â”‚                                   â”‚Sentinelâ”‚        â”‚           â”‚
â”‚                                   â”‚   3    â”‚        â”‚           â”‚
â”‚                                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜        â”‚           â”‚
â”‚                                        â”‚            â”‚           â”‚
â”‚                                        â”‚  "YES"     â”‚           â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  Quorum atteint (2/3) â†’ ODOWN dÃ©clarÃ©                           â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  PHASE 3: LEADER Ã‰LECTION                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚
â”‚                                                                 â”‚
â”‚  t=62s: Vote pour le Sentinel qui fera le failover              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚Sentinelâ”‚â”€â”€"vote for me?"â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   1    â”‚                    â”‚Sentinelâ”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â—€â”€â”€"OK, I vote 1"â”€â”€â”€â”‚   2    â”‚                       â”‚
â”‚      â–²                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚      â”‚                               â”‚                          â”‚
â”‚      â”‚                               â”‚ "vote for me?"           â”‚
â”‚      â”‚                               â–¼                          â”‚
â”‚      â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚      â”‚      "too late,          â”‚Sentinelâ”‚                      â”‚
â”‚      â””â”€â”€â”€â”€â”€voted for 1"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   3    â”‚                      â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                 â”‚
â”‚  Sentinel 1 Ã©lu leader (majority: 2/3 votes)                    â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  PHASE 4: PROMOTION REPLICA                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚
â”‚                                                                 â”‚
â”‚  t=63s: Choisir meilleur replica                                â”‚
â”‚                                                                 â”‚
â”‚  CritÃ¨res de sÃ©lection (ordre de prioritÃ©):                     â”‚
â”‚  1. replica-priority (plus bas = meilleur)                      â”‚
â”‚  2. Replication offset (plus haut = plus Ã  jour)                â”‚
â”‚  3. Runid (ordre lexicographique)                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Priority: 100, Offset: 1000                      â”‚
â”‚  â”‚Replica 1 â”‚                                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Priority: 90, Offset: 998  â† CHOISI!             â”‚
â”‚  â”‚Replica 2 â”‚  (Priority plus bas)                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Priority: 100, Offset: 997                       â”‚
â”‚  â”‚Replica 3 â”‚                                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚                                                                 â”‚
â”‚  t=64s: Promouvoir Replica 2                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚Sentinelâ”‚â”€â”€REPLICAOF NO ONEâ”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   1    â”‚                      â”‚Replica 2 â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                       â”‚                         â”‚
â”‚                                       â”‚ Devient MASTER          â”‚
â”‚                                       â–¼                         â”‚
â”‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                                  â”‚NEW MASTERâ”‚                   â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  PHASE 5: RECONFIGURATION                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚
â”‚                                                                 â”‚
â”‚  t=65s: Reconfigurer autres replicas                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚Sentinelâ”‚â”€â”€REPLICAOF           â”‚NEW MASTERâ”‚                   â”‚
â”‚  â”‚   1    â”‚  new_masterâ”€â”€â”€â”€â”€â”€â–¶   â”‚10.0.1.11 â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚      â”‚                                 â–²                        â”‚
â”‚      â”‚ REPLICAOF                       â”‚ Replication            â”‚
â”‚      â”‚ 10.0.1.11 6379                  â”‚                        â”‚
â”‚      â”‚                                 â”‚                        â”‚
â”‚      â–¼                                 â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚Replica 1 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚Replica 3 â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                 â”‚
â”‚  t=66s: Ancien master (si revient) â†’ devient replica            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚Sentinelâ”‚â”€â”€REPLICAOF           â”‚ Master   â”‚                   â”‚
â”‚  â”‚   1    â”‚  new_masterâ”€â”€â–¶       â”‚ (OLD)    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                       â”‚                         â”‚
â”‚                                       â”‚ Devient REPLICA         â”‚
â”‚                                       â–¼                         â”‚
â”‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                                  â”‚ Replica  â”‚                   â”‚
â”‚                                  â”‚  (OLD M) â”‚                   â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  PHASE 6: NOTIFICATION                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚
â”‚                                                                 â”‚
â”‚  t=67s: Notifier clients et admins                              â”‚
â”‚                                                                 â”‚
â”‚  â€¢ Pub/Sub: +switch-master mymaster 10.0.1.10 10.0.1.11         â”‚
â”‚  â€¢ Scripts: notification-script.sh                              â”‚
â”‚  â€¢ Logs: "[FAILOVER] New master is 10.0.1.11:6379"              â”‚
â”‚                                                                 â”‚
â”‚  DurÃ©e totale: ~35-40 secondes (configurable)                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Algorithme de sÃ©lection du replica

```python
# Pseudo-code de sÃ©lection du meilleur replica

def select_best_replica(replicas):
    """
    SÃ©lectionne le meilleur replica pour promotion
    """
    # Filtrer replicas invalides
    valid_replicas = [
        r for r in replicas
        if r.is_connected()           # ConnectÃ© au master
        and not r.is_disconnected()   # Pas dÃ©connectÃ© rÃ©cemment
        and r.info_refresh_age < 5000 # Info fraÃ®ches (<5s)
        and r.master_link_down_time < 30000  # Link down <30s
    ]

    if not valid_replicas:
        return None

    # Trier par critÃ¨res (ordre de prioritÃ©)
    def sort_key(replica):
        return (
            replica.priority,        # 1. Priority (plus bas = mieux)
            -replica.repl_offset,    # 2. Offset (plus haut = mieux)
            replica.runid            # 3. Runid (tiebreaker)
        )

    valid_replicas.sort(key=sort_key)

    return valid_replicas[0]

# Exemple:
replicas = [
    Replica(priority=100, offset=1000, runid="aaa"),
    Replica(priority=90,  offset=998,  runid="bbb"),  # â† CHOISI
    Replica(priority=100, offset=997,  runid="ccc"),
]

best = select_best_replica(replicas)
# best = Replica(priority=90, offset=998, runid="bbb")
```

---

## âš™ï¸ Configuration complÃ¨te de Sentinel

### Configuration minimale

```ini
# sentinel.conf - Configuration minimale

# Port d'Ã©coute Sentinel
port 26379

# Bind sur toutes interfaces (production: restreindre)
bind 0.0.0.0

# Protection mode (dÃ©sactiver si bind 0.0.0.0)
protected-mode no

# RÃ©pertoire de travail
dir /var/lib/redis/sentinel

# Daemonize (systemd: prÃ©fÃ©rer no)
daemonize no

# PID file
pidfile /var/run/redis/sentinel.pid

# Log file
logfile "/var/log/redis/sentinel.log"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MONITORING CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Monitorer un master
# Format: sentinel monitor <master-name> <ip> <port> <quorum>
sentinel monitor mymaster 10.0.1.10 6379 2

# Authentification du master
sentinel auth-pass mymaster StrongPassword123!

# ConsidÃ©rer master down aprÃ¨s 30s sans rÃ©ponse
sentinel down-after-milliseconds mymaster 30000

# Timeout du failover (3 minutes)
sentinel failover-timeout mymaster 180000

# Nombre de replicas Ã  sync en parallÃ¨le aprÃ¨s failover
sentinel parallel-syncs mymaster 1
```

### Configuration production complÃ¨te

```ini
# sentinel-production.conf - Configuration complÃ¨te

################################# GENERAL #####################################

port 26379
bind 0.0.0.0
protected-mode no
daemonize no
pidfile /var/run/redis/sentinel.pid
logfile "/var/log/redis/sentinel.log"
dir /var/lib/redis/sentinel

# Log level: debug, verbose, notice, warning
loglevel notice

################################ MONITORING ###################################

# Monitorer le master principal
# sentinel monitor <master-name> <ip> <redis-port> <quorum>
# quorum: nombre minimum de Sentinels pour dÃ©clarer ODOWN
sentinel monitor mymaster 10.0.1.10 6379 2

# Authentification
sentinel auth-pass mymaster StrongMasterPassword2024!

# Si master a des users ACL (Redis 6+)
# sentinel auth-user mymaster sentinel_user

################################# TIMEOUTS ####################################

# Temps avant de considÃ©rer instance down (milliseconds)
# Valeur recommandÃ©e: 30000 (30s)
# Trop bas: faux positifs (failover inutiles)
# Trop haut: dÃ©tection lente
sentinel down-after-milliseconds mymaster 30000

# Timeout total du processus de failover
# Si dÃ©passÃ©: abandon et retry
# Valeur recommandÃ©e: 3Ã— down-after-milliseconds
sentinel failover-timeout mymaster 180000

################################# FAILOVER ####################################

# Nombre de replicas Ã  synchroniser en parallÃ¨le aprÃ¨s failover
# 1 = un par un (moins de charge, plus lent)
# >1 = parallÃ¨le (plus rapide, plus de charge)
sentinel parallel-syncs mymaster 1

# DÃ©lai avant de considÃ©rer un replica comme valide pour promotion
# (Ã©viter de promouvoir replica qui vient de dÃ©marrer)
# Redis 6.2+
sentinel replica-validity-time mymaster 180000

################################# SCRIPTS #####################################

# Script exÃ©cutÃ© lors de changements d'Ã©tat
# Arguments: <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port>
sentinel notification-script mymaster /etc/redis/sentinel-notify.sh

# Script exÃ©cutÃ© aprÃ¨s failover pour reconfigurer clients
# Arguments: <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port>
sentinel client-reconfig-script mymaster /etc/redis/sentinel-reconfig.sh

# Timeout d'exÃ©cution des scripts (ms)
sentinel script-max-execution-time 60000

################################## SECURITY ###################################

# DÃ©sactiver reconfiguration dynamique via Sentinel commands
# SÃ©curitÃ©: empÃªche modification config en runtime
sentinel deny-scripts-reconfig yes

# Ne pas rÃ©soudre les hostnames (utiliser IPs)
sentinel resolve-hostnames no
sentinel announce-hostnames no

# Pour Docker/NAT: annoncer IP/port publiques
# sentinel announce-ip 203.0.113.10
# sentinel announce-port 26379

################################# ADVANCED ####################################

# Taux de rafraÃ®chissement des infos (ms)
# Non configurable directement, valeur interne: 10000 (10s)

# Les lignes suivantes sont gÃ©rÃ©es automatiquement par Sentinel
# NE PAS MODIFIER MANUELLEMENT
# sentinel config-epoch mymaster 0
# sentinel leader-epoch mymaster 0
# sentinel known-replica mymaster 10.0.1.11 6379
# sentinel known-replica mymaster 10.0.1.12 6379
# sentinel known-sentinel mymaster 10.0.1.21 26379 ...
# sentinel current-epoch 0
```

### Scripts de notification

**Script de notification** (`sentinel-notify.sh`) :

```bash
#!/bin/bash
# sentinel-notify.sh - Notifications lors d'Ã©vÃ©nements Sentinel

# Arguments fournis par Sentinel:
# $1: <event-type>
# $2: <master-name>
# $3: <role>
# $4: <state>
# $5: <from-ip>
# $6: <from-port>
# $7: <to-ip>
# $8: <to-port>

EVENT_TYPE=$1
MASTER_NAME=$2
ROLE=$3
STATE=$4
FROM_IP=$5
FROM_PORT=$6
TO_IP=$7
TO_PORT=$8

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
LOGFILE="/var/log/redis/sentinel-events.log"

# Logger l'Ã©vÃ©nement
log_event() {
    echo "[$TIMESTAMP] EVENT: $EVENT_TYPE | Master: $MASTER_NAME | $FROM_IP:$FROM_PORT â†’ $TO_IP:$TO_PORT" | tee -a $LOGFILE
}

# Envoyer alerte (exemple: Slack, PagerDuty, email)
send_alert() {
    local message=$1

    # Slack webhook (exemple)
    if [ -n "$SLACK_WEBHOOK" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ Redis Sentinel Alert\\n$message\"}" \
            $SLACK_WEBHOOK
    fi

    # Email (exemple)
    echo "$message" | mail -s "Redis Sentinel Alert: $EVENT_TYPE" ops@company.com

    # PagerDuty (exemple)
    # curl -X POST https://events.pagerduty.com/v2/enqueue \
    #   -H 'Content-Type: application/json' \
    #   -d '{"routing_key":"...","event_action":"trigger","payload":{...}}'
}

# Traiter selon le type d'Ã©vÃ©nement
case $EVENT_TYPE in
    "+switch-master")
        MESSAGE="âš ï¸ FAILOVER COMPLETED\nMaster: $MASTER_NAME\nOld: $FROM_IP:$FROM_PORT\nNew: $TO_IP:$TO_PORT"
        log_event
        send_alert "$MESSAGE"
        ;;

    "+sdown")
        MESSAGE="âš ï¸ SUBJECTIVELY DOWN\nMaster: $MASTER_NAME\nInstance: $FROM_IP:$FROM_PORT"
        log_event
        send_alert "$MESSAGE"
        ;;

    "+odown")
        MESSAGE="ğŸ”¥ OBJECTIVELY DOWN (Quorum reached)\nMaster: $MASTER_NAME\nInstance: $FROM_IP:$FROM_PORT"
        log_event
        send_alert "$MESSAGE"
        ;;

    "-sdown")
        MESSAGE="âœ… SUBJECTIVELY UP (recovered)\nMaster: $MASTER_NAME\nInstance: $FROM_IP:$FROM_PORT"
        log_event
        ;;

    "-odown")
        MESSAGE="âœ… OBJECTIVELY UP (recovered)\nMaster: $MASTER_NAME\nInstance: $FROM_IP:$FROM_PORT"
        log_event
        ;;

    "+failover-end")
        MESSAGE="âœ… FAILOVER FINISHED\nMaster: $MASTER_NAME\nNew Master: $TO_IP:$TO_PORT"
        log_event
        send_alert "$MESSAGE"
        ;;

    "+failover-detected")
        MESSAGE="ğŸ” FAILOVER DETECTED\nMaster: $MASTER_NAME"
        log_event
        ;;

    *)
        MESSAGE="â„¹ï¸ Event: $EVENT_TYPE\nMaster: $MASTER_NAME\nDetails: $FROM_IP:$FROM_PORT â†’ $TO_IP:$TO_PORT"
        log_event
        ;;
esac

exit 0
```

**Script de reconfiguration** (`sentinel-reconfig.sh`) :

```bash
#!/bin/bash
# sentinel-reconfig.sh - Reconfiguration aprÃ¨s failover

MASTER_NAME=$2
NEW_MASTER_IP=$7
NEW_MASTER_PORT=$8

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
LOGFILE="/var/log/redis/sentinel-reconfig.log"

echo "[$TIMESTAMP] Reconfiguring for new master: $NEW_MASTER_IP:$NEW_MASTER_PORT" | tee -a $LOGFILE

# Exemple: Mettre Ã  jour HAProxy backend
if command -v socat &> /dev/null; then
    echo "Updating HAProxy backend..."
    echo "set server redis-backend/redis-master addr $NEW_MASTER_IP port $NEW_MASTER_PORT" | \
        socat stdio /var/run/haproxy.sock
fi

# Exemple: Mettre Ã  jour fichier de configuration applicatif
CONFIG_FILE="/etc/app/redis-config.json"
if [ -f "$CONFIG_FILE" ]; then
    echo "Updating application config..."
    jq ".redis.master.host = \"$NEW_MASTER_IP\" | .redis.master.port = $NEW_MASTER_PORT" \
        $CONFIG_FILE > $CONFIG_FILE.tmp && mv $CONFIG_FILE.tmp $CONFIG_FILE
fi

# Exemple: Notifier service via API
API_URL="http://config-service.internal/api/redis/master"
curl -X POST -H "Content-Type: application/json" \
    -d "{\"master\":\"$NEW_MASTER_IP:$NEW_MASTER_PORT\"}" \
    $API_URL

echo "[$TIMESTAMP] Reconfiguration completed" | tee -a $LOGFILE

exit 0
```

---

## ğŸ” Quorum et Consensus

### Comprendre le quorum

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MÃ‰CANISME DE QUORUM                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Quorum: Nombre minimum de Sentinels devant s'accorder         â”‚
â”‚                                                                â”‚
â”‚  Configuration: sentinel monitor mymaster 10.0.1.10 6379 Q     â”‚
â”‚                                                         â†‘      â”‚
â”‚                                                      Quorum    â”‚
â”‚                                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                â”‚
â”‚  ScÃ©nario 1: 3 Sentinels, Quorum = 2                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â”‚  S1: Master is DOWN                          â”‚              â”‚
â”‚  â”‚  S2: Master is DOWN     â† Quorum atteint!    â”‚              â”‚
â”‚  â”‚  S3: Master is UP                            â”‚              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â”‚  RÃ©sultat: 2/3 = ODOWN â†’ Failover dÃ©clenchÃ©  â”‚              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                â”‚
â”‚  ScÃ©nario 2: 3 Sentinels, Quorum = 3                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â”‚  S1: Master is DOWN                          â”‚              â”‚
â”‚  â”‚  S2: Master is DOWN                          â”‚              â”‚
â”‚  â”‚  S3: Master is UP       â† Quorum NON atteint â”‚              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â”‚  RÃ©sultat: 2/3 < 3 = SDOWN seulement         â”‚              â”‚
â”‚  â”‚  Pas de failover                             â”‚              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                â”‚
â”‚  ScÃ©nario 3: Network Partition                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Partition 1:        â”‚  Partition 2:         â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”              â”‚  â”Œâ”€â”€â”€â”€â”               â”‚              â”‚
â”‚  â”‚  â”‚ S1 â”‚ (isolated)   â”‚  â”‚ S2 â”‚â”€â”€â”€â”           â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜              â”‚  â””â”€â”€â”€â”€â”˜   â”‚           â”‚              â”‚
â”‚  â”‚                      â”‚           â”‚           â”‚              â”‚
â”‚  â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”   â”‚           â”‚              â”‚
â”‚  â”‚                      â”‚  â”‚ S3 â”‚â”€â”€â”€â”˜           â”‚              â”‚
â”‚  â”‚                      â”‚  â””â”€â”€â”€â”€â”˜               â”‚              â”‚
â”‚  â”‚                      â”‚                       â”‚              â”‚
â”‚  â”‚  S1 seul:            â”‚  S2 + S3:             â”‚              â”‚
â”‚  â”‚  â€¢ Voit master down  â”‚  â€¢ Voient master UP   â”‚              â”‚
â”‚  â”‚  â€¢ SDOWN seulement   â”‚  â€¢ Pas de ODOWN       â”‚              â”‚
â”‚  â”‚  â€¢ Pas de failover   â”‚  â€¢ Pas de failover    â”‚              â”‚
â”‚  â”‚    (1 < quorum 2)    â”‚    (0 < quorum 2)     â”‚              â”‚
â”‚  â”‚                      â”‚                       â”‚              â”‚
â”‚  â”‚  âœ… Split-brain Ã©vitÃ© grÃ¢ce au quorum        â”‚              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Calcul du quorum optimal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RÃˆGLES DE DIMENSIONNEMENT DU QUORUM                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Formule: Quorum = (N / 2) + 1                                  â”‚
â”‚           oÃ¹ N = nombre total de Sentinels                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Sentinels â”‚ Quorum   â”‚ TolÃ¨re pannes â”‚ Recommandation    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚     1     â”‚    1     â”‚      0        â”‚ âŒ Jamais!        â”‚   â”‚
â”‚  â”‚     2     â”‚    2     â”‚      0        â”‚ âŒ Inutile        â”‚   â”‚
â”‚  â”‚     3     â”‚    2     â”‚      1        â”‚ âœ… Minimum        â”‚   â”‚
â”‚  â”‚     4     â”‚    3     â”‚      1        â”‚ âš ï¸  Sous-optimal  â”‚   â”‚
â”‚  â”‚     5     â”‚    3     â”‚      2        â”‚ âœ… RecommandÃ©     â”‚   â”‚
â”‚  â”‚     6     â”‚    4     â”‚      2        â”‚ âš ï¸  Sous-optimal  â”‚   â”‚
â”‚  â”‚     7     â”‚    4     â”‚      3        â”‚ âœ… Grande org     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  RÃ¨gles:                                                        â”‚
â”‚  â€¢ Toujours un nombre IMPAIR de Sentinels (3, 5, 7)             â”‚
â”‚  â€¢ Nombre pair = gaspillage de ressources                       â”‚
â”‚  â€¢ Minimum absolu: 3 Sentinels (tolÃ©rer 1 panne)                â”‚
â”‚  â€¢ Standard production: 3 Sentinels                             â”‚
â”‚  â€¢ Large scale: 5 ou 7 Sentinels                                â”‚
â”‚                                                                 â”‚
â”‚  Exemples de configuration:                                     â”‚
â”‚                                                                 â”‚
â”‚  PME / Startup:                                                 â”‚
â”‚  â€¢ 3 Sentinels                                                  â”‚
â”‚  â€¢ Quorum = 2                                                   â”‚
â”‚  â€¢ 1 Sentinel par AZ (3 AZs)                                    â”‚
â”‚                                                                 â”‚
â”‚  Entreprise:                                                    â”‚
â”‚  â€¢ 5 Sentinels                                                  â”‚
â”‚  â€¢ Quorum = 3                                                   â”‚
â”‚  â€¢ 2 Sentinels par datacenter (2 DCs) + 1 tiebreaker            â”‚
â”‚                                                                 â”‚
â”‚  Global / Multi-rÃ©gion:                                         â”‚
â”‚  â€¢ 7 Sentinels                                                  â”‚
â”‚  â€¢ Quorum = 4                                                   â”‚
â”‚  â€¢ 3 rÃ©gions avec 2-3 Sentinels chacune                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Epoch et leader election

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EPOCH ET Ã‰LECTION DU LEADER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Current Epoch: Compteur global incrÃ©mentÃ© Ã  chaque failover    â”‚
â”‚                                                                 â”‚
â”‚  Processus d'Ã©lection:                                          â”‚
â”‚                                                                 â”‚
â”‚  1. Sentinel dÃ©tecte ODOWN                                      â”‚
â”‚     â†“                                                           â”‚
â”‚  2. IncrÃ©mente son current-epoch local                          â”‚
â”‚     Current epoch: 5 â†’ 6                                        â”‚
â”‚     â†“                                                           â”‚
â”‚  3. Envoie SENTINEL IS-MASTER-DOWN-BY-ADDR avec epoch           â”‚
â”‚     Demande: "Vote for me to do failover at epoch 6"            â”‚
â”‚     â†“                                                           â”‚
â”‚  4. Autres Sentinels rÃ©pondent:                                 â”‚
â”‚     â€¢ Si epoch < local epoch: Refus                             â”‚
â”‚     â€¢ Si epoch = local epoch ET pas encore votÃ©: Accepte        â”‚
â”‚     â€¢ Si epoch = local epoch ET dÃ©jÃ  votÃ©: Refus                â”‚
â”‚     â†“                                                           â”‚
â”‚  5. Si majoritÃ© obtenue (â‰¥ quorum):                             â”‚
â”‚     â†’ Sentinel devient LEADER                                   â”‚
â”‚     â†’ Commence le failover                                      â”‚
â”‚     â†“                                                           â”‚
â”‚  6. Si majoritÃ© NON obtenue:                                    â”‚
â”‚     â†’ Attendre et rÃ©essayer avec epoch+1                        â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                 â”‚
â”‚  Exemple Timeline:                                              â”‚
â”‚                                                                 â”‚
â”‚  t=0: Current epoch = 5                                         â”‚
â”‚                                                                 â”‚
â”‚  t=30s: Sentinel 1 dÃ©tecte ODOWN                                â”‚
â”‚    â€¢ Epoch 5 â†’ 6                                                â”‚
â”‚    â€¢ Demande votes pour epoch 6                                 â”‚
â”‚                                                                 â”‚
â”‚  t=30.1s: Sentinel 2 et 3 reÃ§oivent demande                     â”‚
â”‚    â€¢ Epoch 5 â†’ 6                                                â”‚
â”‚    â€¢ Votent pour Sentinel 1                                     â”‚
â”‚                                                                 â”‚
â”‚  t=30.5s: Sentinel 1 Ã©lu (2/3 votes)                            â”‚
â”‚    â€¢ Leader epoch: 6                                            â”‚
â”‚    â€¢ Commence failover                                          â”‚
â”‚                                                                 â”‚
â”‚  t=45s: Failover terminÃ©                                        â”‚
â”‚    â€¢ Config epoch: 6 (enregistrÃ©)                               â”‚
â”‚    â€¢ Tous Sentinels synchronisÃ©s sur epoch 6                    â”‚
â”‚                                                                 â”‚
â”‚  Protection contre split-brain:                                 â”‚
â”‚  â€¢ Un seul Sentinel peut Ãªtre Ã©lu par epoch                     â”‚
â”‚  â€¢ NÃ©cessite majoritÃ© absolue (quorum)                          â”‚
â”‚  â€¢ Epoch garantit ordre des failovers                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¡ Commandes Sentinel utiles

### Commandes de monitoring

```bash
# Se connecter Ã  un Sentinel
redis-cli -p 26379

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INFORMATIONS GÃ‰NÃ‰RALES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Lister les masters monitorÃ©s
SENTINEL masters

# DÃ©tails d'un master spÃ©cifique
SENTINEL master mymaster

# Output exemple:
# 1) "name"
# 2) "mymaster"
# 3) "ip"
# 4) "10.0.1.10"
# 5) "port"
# 6) "6379"
# 7) "runid"
# 8) "abc123..."
# 9) "flags"
# 10) "master"
# 11) "link-pending-commands"
# 12) "0"
# 13) "link-refcount"
# 14) "1"
# 15) "last-ping-sent"
# 16) "0"
# 17) "last-ok-ping-reply"
# 18) "142"
# 19) "last-ping-reply"
# 20) "142"
# 21) "down-after-milliseconds"
# 22) "30000"
# 23) "info-refresh"
# 24) "5123"
# 25) "role-reported"
# 26) "master"
# 27) "role-reported-time"
# 28) "12345678"
# 29) "config-epoch"
# 30) "5"
# 31) "num-slaves"
# 32) "2"
# 33) "num-other-sentinels"
# 34) "2"
# 35) "quorum"
# 36) "2"
# 37) "failover-timeout"
# 38) "180000"
# 39) "parallel-syncs"
# 40) "1"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REPLICAS ET SENTINELS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Lister les replicas d'un master
SENTINEL replicas mymaster
# ou
SENTINEL slaves mymaster  # Ancienne syntaxe

# Lister les autres Sentinels
SENTINEL sentinels mymaster

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OBTENIR L'ADRESSE DU MASTER ACTUEL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Obtenir IP:port du master actuel (crucial pour clients)
SENTINEL get-master-addr-by-name mymaster

# Output:
# 1) "10.0.1.10"
# 2) "6379"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ã‰TAT ET SANTÃ‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# VÃ©rifier si Sentinel pense que master est down
SENTINEL is-master-down-by-addr 10.0.1.10 6379 0 *

# Output:
# 1) (integer) 1    â† 1 = down, 0 = up
# 2) (nil)          â† Leader runid (si Ã©lection en cours)
# 3) (integer) 5    â† Current epoch

# VÃ©rifier santÃ© du Sentinel lui-mÃªme
SENTINEL ckquorum mymaster

# Output:
# OK 3 usable Sentinels. Quorum and failover authorization can be reached

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACTIONS ADMINISTRATIVES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Forcer un failover (test ou urgence)
SENTINEL failover mymaster

# RÃ©initialiser l'Ã©tat d'un master
# (oublier anciens replicas/sentinels, re-dÃ©couvrir)
SENTINEL reset mymaster

# Supprimer complÃ¨tement un master du monitoring
SENTINEL remove mymaster

# Ajouter un nouveau master Ã  monitorer
SENTINEL monitor newmaster 10.0.2.10 6379 2

# Modifier configuration en runtime
SENTINEL set mymaster down-after-milliseconds 60000
SENTINEL set mymaster quorum 3

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEBUG ET TROUBLESHOOTING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Voir tous les Ã©vÃ©nements enregistrÃ©s
SENTINEL pending-scripts

# Informations Sentinel gÃ©nÃ©rales
INFO sentinel

# Simuler une panne (test)
# (exÃ©cutÃ© sur le master Redis, pas Sentinel)
# redis-cli -h 10.0.1.10 DEBUG sleep 60
```

### Scripts de monitoring automatisÃ©

```bash
#!/bin/bash
# sentinel-health-check.sh - VÃ©rification santÃ© complÃ¨te

SENTINEL_HOST="localhost"
SENTINEL_PORT="26379"
MASTER_NAME="mymaster"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Redis Sentinel Health Check"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Date: $(date)"
echo ""

# Fonction pour exÃ©cuter commande Sentinel
sentinel_cmd() {
    redis-cli -h $SENTINEL_HOST -p $SENTINEL_PORT "$@"
}

# 1. VÃ©rifier connectivitÃ© Sentinel
echo "1. Sentinel Connectivity"
if sentinel_cmd PING > /dev/null 2>&1; then
    echo "   âœ… Sentinel is reachable"
else
    echo "   âŒ Sentinel is NOT reachable"
    exit 1
fi
echo ""

# 2. Informations Master
echo "2. Master Information"
MASTER_INFO=$(sentinel_cmd SENTINEL get-master-addr-by-name $MASTER_NAME)
if [ -n "$MASTER_INFO" ]; then
    MASTER_IP=$(echo "$MASTER_INFO" | head -n1)
    MASTER_PORT=$(echo "$MASTER_INFO" | tail -n1)
    echo "   Master: $MASTER_IP:$MASTER_PORT"

    # VÃ©rifier si master est accessible
    if redis-cli -h $MASTER_IP -p $MASTER_PORT PING > /dev/null 2>&1; then
        echo "   âœ… Master is accessible"
    else
        echo "   âŒ Master is NOT accessible"
    fi
else
    echo "   âŒ No master found for '$MASTER_NAME'"
fi
echo ""

# 3. Ã‰tat du Master selon Sentinel
echo "3. Master Status"
sentinel_cmd SENTINEL master $MASTER_NAME | while read -r line; do
    case "$line" in
        "flags")
            read -r flags
            echo "   Flags: $flags"
            if [[ "$flags" == *"down"* ]]; then
                echo "   âš ï¸  WARNING: Master is marked as DOWN"
            fi
            ;;
        "num-slaves")
            read -r num
            echo "   Replicas: $num"
            if [ "$num" -lt 1 ]; then
                echo "   âš ï¸  WARNING: No replicas connected"
            fi
            ;;
        "num-other-sentinels")
            read -r num
            echo "   Other Sentinels: $num"
            if [ "$num" -lt 2 ]; then
                echo "   âš ï¸  WARNING: Less than 2 other Sentinels"
            fi
            ;;
        "quorum")
            read -r quorum
            echo "   Quorum: $quorum"
            ;;
    esac
done
echo ""

# 4. VÃ©rifier quorum
echo "4. Quorum Check"
CKQUORUM=$(sentinel_cmd SENTINEL ckquorum $MASTER_NAME)
echo "   $CKQUORUM"
if [[ "$CKQUORUM" == *"OK"* ]]; then
    echo "   âœ… Quorum is satisfied"
else
    echo "   âŒ Quorum is NOT satisfied"
fi
echo ""

# 5. Lister les replicas
echo "5. Replicas"
sentinel_cmd SENTINEL replicas $MASTER_NAME | grep -E "^(name|ip|port|flags|master-link-status)" | \
while read -r key; do
    read -r value
    if [ "$key" = "name" ]; then
        echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    fi
    echo "   $key: $value"
done
echo ""

# 6. Lister les autres Sentinels
echo "6. Other Sentinels"
sentinel_cmd SENTINEL sentinels $MASTER_NAME | grep -E "^(name|ip|port|flags)" | \
while read -r key; do
    read -r value
    if [ "$key" = "name" ]; then
        echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    fi
    echo "   $key: $value"
done
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Health Check Complete"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
```

---

## ğŸ“ Points clÃ©s Ã  retenir

1. **Sentinel = HA layer** : Monitoring + Failover + Service Discovery
2. **Minimum 3 Sentinels** : Nombre impair (3, 5, 7), jamais pair
3. **Quorum = (N/2) + 1** : Consensus requis pour ODOWN
4. **SDOWN vs ODOWN** : Subjectif (1 Sentinel) vs Objectif (quorum)
5. **Epoch** : Compteur global empÃªchant conflits de failover
6. **DurÃ©e failover** : 30-60s typique (configurable)
7. **Scripts notification** : Alertes et reconfig automatisÃ©es
8. **Service Discovery** : Clients interrogent Sentinels pour trouver master
9. **Pas un proxy** : Clients se connectent directement Ã  Redis
10. **Testing rÃ©gulier** : Tester failover en staging avant prod

---

## ğŸ”— RÃ©fÃ©rences

- [Redis Sentinel Documentation](https://redis.io/docs/management/sentinel/)
- [Sentinel Specification](https://redis.io/topics/sentinel)
- [Sentinel Client Guidelines](https://redis.io/topics/sentinel-clients)

---

**Section suivante** : [10.4 Configuration et dÃ©ploiement de Sentinel](./04-configuration-deploiement-sentinel.md)

â­ï¸ [Configuration et dÃ©ploiement de Sentinel](/10-architecture-haute-disponibilite/04-configuration-deploiement-sentinel.md)
