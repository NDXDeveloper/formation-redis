ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 10.5 Split-brain et Quorum : Comprendre les risques

## Introduction

Le **split-brain** est l'un des problÃ¨mes les plus critiques et dangereux dans les systÃ¨mes distribuÃ©s. Il survient lorsqu'une partition rÃ©seau crÃ©e plusieurs "vues" du systÃ¨me, chacune pensant Ãªtre la seule valide. Dans le contexte de Redis Sentinel, cela peut conduire Ã  avoir plusieurs masters actifs simultanÃ©ment, causant des incohÃ©rences de donnÃ©es irrÃ©versibles.

Cette section explique en profondeur les mÃ©canismes qui protÃ¨gent contre le split-brain, comment le quorum fonctionne, et les configurations critiques pour minimiser les risques.

---

## ğŸ§  Qu'est-ce que le Split-Brain ?

### DÃ©finition

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SPLIT-BRAIN : DÃ‰FINITION                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Ã‰tat oÃ¹ un systÃ¨me distribuÃ© est divisÃ© en partitions          â”‚
â”‚  indÃ©pendantes, chacune pensant Ãªtre la partition valide        â”‚
â”‚  et prenant des dÃ©cisions conflictuelles.                       â”‚
â”‚                                                                 â”‚
â”‚  ConsÃ©quences dans Redis:                                       â”‚
â”‚  â€¢ Plusieurs masters actifs simultanÃ©ment                       â”‚
â”‚  â€¢ Ã‰criture sur des masters diffÃ©rents                          â”‚
â”‚  â€¢ DonnÃ©es divergentes (impossibles Ã  rÃ©concilier)              â”‚
â”‚  â€¢ Perte de donnÃ©es lors de la rÃ©unification                    â”‚
â”‚                                                                 â”‚
â”‚  Analogie:                                                      â”‚
â”‚  Un pays divisÃ© en deux gouvernements, chacun pensant           â”‚
â”‚  Ãªtre le gouvernement lÃ©gitime et prenant des dÃ©cisions         â”‚
â”‚  contradictoires. Quand le pays se rÃ©unifie, impossible         â”‚
â”‚  de rÃ©concilier toutes les dÃ©cisions prises.                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ScÃ©nario classique de split-brain

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCÃ‰NARIO SPLIT-BRAIN COMPLET                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  t=0: Ã‰tat initial normal                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚     Datacenter A              â”‚      Datacenter B               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Sentinel 1      â”‚         â”‚   â”‚  Sentinel 3      â”‚          â”‚
â”‚  â”‚  Sentinel 2      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤                  â”‚          â”‚
â”‚  â”‚                  â”‚  RÃ©seau â”‚   â”‚                  â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   OK    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚  â”‚  â”‚   MASTER   â”‚  â”‚         â”‚   â”‚  â”‚  Replica   â”‚  â”‚          â”‚
â”‚  â”‚  â”‚ 10.1.0.10  â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤  â”‚ 10.2.0.10  â”‚  â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚  â”‚                  â”‚         â”‚   â”‚                  â”‚          â”‚
â”‚  â”‚  Clients DC-A    â”‚         â”‚   â”‚  Clients DC-B    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â”‚  Tout fonctionne : 1 master, 1 replica, 3 sentinels             â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚  t=30s: Partition rÃ©seau (cÃ¢ble coupÃ©, firewall, routing)       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚     Datacenter A              âœ—      Datacenter B               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    PARTITION  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Sentinel 1      â”‚         âœ—     â”‚  Sentinel 3      â”‚        â”‚
â”‚  â”‚  Sentinel 2      â”‚âœ— NO    âœ—      â”‚                  â”‚        â”‚
â”‚  â”‚                  â”‚ COMM   âœ—      â”‚                  â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        âœ—      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚
â”‚  â”‚  â”‚   MASTER   â”‚  â”‚        âœ—      â”‚  â”‚  Replica   â”‚  â”‚        â”‚
â”‚  â”‚  â”‚ 10.1.0.10  â”‚âœ—â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€âœ—â”€â”€â”€â”€â”€â”€â”¤  â”‚ 10.2.0.10  â”‚  â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        âœ—      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚
â”‚  â”‚       â–²          â”‚        âœ—      â”‚       â”‚          â”‚        â”‚
â”‚  â”‚       â”‚          â”‚        âœ—      â”‚       â”‚ Replica  â”‚        â”‚
â”‚  â”‚  Clients DC-A    â”‚        âœ—      â”‚  Clients DC-B    â”‚        â”‚
â”‚  â”‚  (continuent     â”‚        âœ—      â”‚  (ne peuvent     â”‚        â”‚
â”‚  â”‚   Ã  Ã©crire)      â”‚        âœ—      â”‚   plus lire)     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        âœ—      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                 â”‚
â”‚  Partition 1 (DC-A):                Partition 2 (DC-B):         â”‚
â”‚  â€¢ 2 Sentinels                      â€¢ 1 Sentinel                â”‚
â”‚  â€¢ Master actif                     â€¢ Replica dÃ©connectÃ©        â”‚
â”‚  â€¢ Quorum = 2                       â€¢ Quorum = 2                â”‚
â”‚  â€¢ 2/2 Sentinels OK âœ…              â€¢ 1/2 Sentinels âŒ
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚  t=60s: Sentinel 3 dÃ©tecte master down â†’ tente failover         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚     Datacenter A              âœ—      Datacenter B               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         âœ—   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Sentinel 1      â”‚         âœ—   â”‚  Sentinel 3      â”‚          â”‚
â”‚  â”‚  Sentinel 2      â”‚         âœ—   â”‚  (tente vote)    â”‚          â”‚
â”‚  â”‚                  â”‚         âœ—   â”‚  âŒ QUORUM NON   â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         âœ—   â”‚     ATTEINT      â”‚          â”‚
â”‚  â”‚  â”‚   MASTER   â”‚  â”‚         âœ—   â”‚                  â”‚          â”‚
â”‚  â”‚  â”‚ 10.1.0.10  â”‚  â”‚         âœ—   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚  â”‚  â”‚ (ACTIVE)   â”‚  â”‚         âœ—   â”‚  â”‚  Replica   â”‚  â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         âœ—   â”‚  â”‚ 10.2.0.10  â”‚  â”‚          â”‚
â”‚  â”‚       â–²          â”‚         âœ—   â”‚  â”‚ (en attente)  â”‚          â”‚
â”‚  â”‚       â”‚          â”‚         âœ—   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚  â”‚  Clients DC-A    â”‚         âœ—   â”‚                  â”‚          â”‚
â”‚  â”‚  WRITE("user:1") â”‚         âœ—   â”‚  Clients DC-B    â”‚          â”‚
â”‚  â”‚  = "Alice"       â”‚         âœ—   â”‚  (timeout)       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         âœ—   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â”‚  DC-A: Master continue Ã  servir (clients locaux OK)             â”‚
â”‚  DC-B: Sentinel 3 ne peut pas faire failover (1 < quorum 2)     â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸  SI QUORUM Ã‰TAIT MAL CONFIGURÃ‰ (1 au lieu de 2):            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚  t=60s: AVEC QUORUM=1 (MAUVAISE CONFIG) âŒ                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚     Datacenter A              âœ—      Datacenter B               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         âœ—   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Sentinel 1, 2   â”‚         âœ—   â”‚  Sentinel 3      â”‚          â”‚
â”‚  â”‚                  â”‚         âœ—   â”‚  âœ… Quorum OK    â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         âœ—   â”‚  (1 â‰¥ 1)         â”‚          â”‚
â”‚  â”‚  â”‚ OLD MASTER â”‚  â”‚         âœ—   â”‚                  â”‚          â”‚
â”‚  â”‚  â”‚ 10.1.0.10  â”‚  â”‚         âœ—   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚  â”‚  â”‚ (ACTIVE) âœ…â”‚  â”‚         âœ—   â”‚  â”‚NEW MASTER  â”‚  â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         âœ—   â”‚  â”‚ 10.2.0.10  â”‚  â”‚          â”‚
â”‚  â”‚       â–²          â”‚         âœ—   â”‚  â”‚ (PROMOTED!)â”‚  â”‚          â”‚
â”‚  â”‚       â”‚          â”‚         âœ—   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚  â”‚  Clients DC-A    â”‚         âœ—   â”‚       â–²          â”‚          â”‚
â”‚  â”‚  WRITE("user:1") â”‚         âœ—   â”‚  Clients DC-B    â”‚          â”‚
â”‚  â”‚  = "Alice"       â”‚         âœ—   â”‚  WRITE("user:1") â”‚          â”‚
â”‚  â”‚                  â”‚         âœ—   â”‚  = "Bob"         â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         âœ—   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¥ SPLIT-BRAIN!                                                â”‚
â”‚  â€¢ 2 masters actifs simultanÃ©ment                               â”‚
â”‚  â€¢ Ã‰critures divergentes : user:1 = Alice ET Bob                â”‚
â”‚  â€¢ Impossible de rÃ©concilier automatiquement                    â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                 â”‚
â”‚  t=120s: RÃ©seau revient                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚     Datacenter A              â”‚      Datacenter B               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Sentinel 1, 2   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤  Sentinel 3      â”‚          â”‚
â”‚  â”‚                  â”‚  RÃ©seau â”‚   â”‚                  â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   OK    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚  â”‚  â”‚ OLD MASTER â”‚  â”‚         â”‚   â”‚  â”‚ NEW MASTER â”‚  â”‚          â”‚
â”‚  â”‚  â”‚ 10.1.0.10  â”‚  â”‚         â”‚   â”‚  â”‚ 10.2.0.10  â”‚  â”‚          â”‚
â”‚  â”‚  â”‚ epoch: 5   â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤  â”‚ epoch: 6   â”‚  â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚  â”‚  user:1="Alice"  â”‚         â”‚   â”‚  user:1="Bob"    â”‚          â”‚
â”‚  â”‚                  â”‚         â”‚   â”‚                  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â”‚  RÃ©solution:                                                    â”‚
â”‚  â€¢ Sentinel dÃ©tecte epoch 6 > epoch 5                           â”‚
â”‚  â€¢ OLD MASTER (10.1.0.10) devient REPLICA de NEW MASTER         â”‚
â”‚  â€¢ OLD MASTER fait FULL RESYNC â†’ PERD TOUTES SES DONNÃ‰ES        â”‚
â”‚  â€¢ user:1 = "Bob" (donnÃ©es de DC-B)                             â”‚
â”‚  â€¢ âŒ PERTE: user:1 = "Alice" (toutes les Ã©critures DC-A)       â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¥ TOUTES LES Ã‰CRITURES PENDANT LA PARTITION SONT PERDUES      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¢ Le Quorum : MÃ©canisme de protection

### Principe du quorum

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QUORUM : DÃ‰FINITION ET FONCTIONNEMENT                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Quorum = Nombre MINIMUM de Sentinels devant s'accorder         â”‚
â”‚           pour prendre une dÃ©cision (ODOWN + Failover)          â”‚
â”‚                                                                 â”‚
â”‚  Configuration:                                                 â”‚
â”‚  sentinel monitor mymaster 10.0.1.10 6379 Q                     â”‚
â”‚                                         â†‘                       â”‚
â”‚                                      Quorum                     â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Formule optimale: Q = (N / 2) + 1                              â”‚
â”‚                    oÃ¹ N = nombre total de Sentinels             â”‚
â”‚                                                                 â”‚
â”‚  Exemples:                                                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Sentinels â”‚ Quorum  â”‚ TolÃ¨re     â”‚ Cas d'usage          â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚     1     â”‚    1    â”‚ 0 pannes   â”‚ âŒ Jamais utiliser   â”‚    â”‚
â”‚  â”‚     2     â”‚    2    â”‚ 0 pannes   â”‚ âŒ Inutile           â”‚    â”‚
â”‚  â”‚     3     â”‚    2    â”‚ 1 panne    â”‚ âœ… Minimum prod      â”‚    â”‚
â”‚  â”‚     4     â”‚    3    â”‚ 1 panne    â”‚ âš ï¸  Gaspillage       â”‚    â”‚
â”‚  â”‚     5     â”‚    3    â”‚ 2 pannes   â”‚ âœ… RecommandÃ© HA     â”‚    â”‚
â”‚  â”‚     6     â”‚    4    â”‚ 2 pannes   â”‚ âš ï¸  Gaspillage       â”‚    â”‚
â”‚  â”‚     7     â”‚    4    â”‚ 3 pannes   â”‚ âœ… Grande Ã©chelle    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Processus de dÃ©cision avec Quorum:                             â”‚
â”‚                                                                 â”‚
â”‚  1. Sentinel A dÃ©tecte master down (SDOWN)                      â”‚
â”‚     â†“                                                           â”‚
â”‚  2. Sentinel A demande avis aux autres :                        â”‚
â”‚     "Est-ce que vous aussi voyez master down?"                  â”‚
â”‚     â†“                                                           â”‚
â”‚  3. Si â‰¥ Q Sentinels disent "OUI" â†’ ODOWN                       â”‚
â”‚     â†“                                                           â”‚
â”‚  4. Vote pour Ã©lire un leader de failover                       â”‚
â”‚     Si â‰¥ Q votes pour un Sentinel â†’ Il devient leader           â”‚
â”‚     â†“                                                           â”‚
â”‚  5. Leader fait le failover                                     â”‚
â”‚                                                                 â”‚
â”‚  Protection split-brain:                                        â”‚
â”‚  â€¢ Dans une partition avec < Q Sentinels:                       â”‚
â”‚    â†’ Impossible de dÃ©clarer ODOWN                               â”‚
â”‚    â†’ Impossible de faire failover                               â”‚
â”‚    â†’ âœ… Pas de split-brain                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Quorum mal configurÃ© : dangers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DANGERS D'UN QUORUM MAL CONFIGURÃ‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Danger 1: Quorum trop BAS (Q = 1 avec 3 Sentinels)             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Configuration: sentinel monitor mymaster 10.0.1.10 6379 1      â”‚
â”‚                                                         â†‘       â”‚
â”‚                                                   DANGEREUX!    â”‚
â”‚                                                                 â”‚
â”‚  ProblÃ¨me: N'importe quel Sentinel SEUL peut dÃ©clencher         â”‚
â”‚            un failover                                          â”‚
â”‚                                                                 â”‚
â”‚  ScÃ©nario problÃ©matique:                                        â”‚
â”‚                                                                 â”‚
â”‚     Partition A          â”‚         Partition B                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Sentinel 1    â”‚  âœ—   â”‚      â”‚  Sentinel 2, 3 â”‚              â”‚
â”‚  â”‚  (1 â‰¥ Q=1) âœ…  â”‚  âœ—   â”‚      â”‚  (2 â‰¥ Q=1) âœ…  â”‚
â”‚  â”‚                â”‚      â”‚      â”‚                â”‚              â”‚
â”‚  â”‚  Master A âœ…   â”‚  âœ—   â”‚      â”‚  Master B âœ…   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚  RÃ©sultat: 2 masters crÃ©Ã©s â†’ SPLIT-BRAIN                        â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Danger 2: Quorum trop HAUT (Q = 3 avec 3 Sentinels)            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Configuration: sentinel monitor mymaster 10.0.1.10 6379 3      â”‚
â”‚                                                         â†‘       â”‚
â”‚                                                     Trop strict!â”‚
â”‚                                                                 â”‚
â”‚  ProblÃ¨me: AUCUNE panne tolÃ©rÃ©e. Si 1 Sentinel down,            â”‚
â”‚            failover impossible (2 < Q=3)                        â”‚
â”‚                                                                 â”‚
â”‚  ScÃ©nario problÃ©matique:                                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Sentinel 1 â”‚  â”‚ Sentinel 2 â”‚  â”‚ Sentinel 3 â”‚                 â”‚
â”‚  â”‚    OK      â”‚  â”‚    OK      â”‚  â”‚  âœ— DOWN    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                â”‚                                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚          â”‚   Master   â”‚ âœ— DOWN                                  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                                 â”‚
â”‚  Sentinels actifs: 2                                            â”‚
â”‚  Votes possibles: 2                                             â”‚
â”‚  Quorum requis: 3                                               â”‚
â”‚  RÃ©sultat: 2 < 3 â†’ âŒ PAS DE FAILOVER                           â”‚
â”‚            Master reste down, service interrompu                â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Configuration CORRECTE avec 3 Sentinels:                       â”‚
â”‚                                                                 â”‚
â”‚  sentinel monitor mymaster 10.0.1.10 6379 2                     â”‚
â”‚                                                         â†‘       â”‚
â”‚                                                  Q = (3/2)+1=2  â”‚
â”‚                                                                 â”‚
â”‚  â€¢ TolÃ¨re 1 panne Sentinel                                      â”‚
â”‚  â€¢ EmpÃªche split-brain (nÃ©cessite majoritÃ©)                     â”‚
â”‚  â€¢ Permet failover mÃªme si 1 Sentinel down                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ Protections contre le Split-Brain

### Protection 1 : min-replicas-to-write

Configuration critique sur le **Master Redis** :

```ini
# redis.conf (Master)

# Refuser les Ã©critures si < N replicas connectÃ©s
min-replicas-to-write 1

# Refuser les Ã©critures si replicas ont > X secondes de lag
min-replicas-max-lag 10
```

**MÃ©canisme** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROTECTION: min-replicas-to-write                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Configuration Master: min-replicas-to-write 1                  â”‚
â”‚                        min-replicas-max-lag 10                  â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  ScÃ©nario: Partition rÃ©seau                                     â”‚
â”‚                                                                 â”‚
â”‚     Partition A          âœ—         Partition B                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      âœ—      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      âœ—      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚  â”‚  MASTER  â”‚  â”‚      âœ—      â”‚  â”‚ Replica  â”‚  â”‚              â”‚
â”‚  â”‚  â”‚10.1.0.10 â”‚âœ—â”€â”¼â”€â”€â”€â”€â”€â”€âœ—â”€â”€â”€â”€â”€â”€â”¤  â”‚10.2.0.10 â”‚  â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚      âœ—      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚  â”‚       â”‚        â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚       â”‚ Check: â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚       â”‚ Combienâ”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚       â”‚ replicas?            â”‚                â”‚              â”‚
â”‚  â”‚       â”‚        â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚       â–¼        â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  Connected     â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  replicas: 0   â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  Required: 1   â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚                â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  0 < 1 â†’ âŒ    â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  REFUSE WRITES â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚                â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  â”‚  Client  â”‚  â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚       â”‚        â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚       â”‚ WRITE  â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚       â–¼        â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  -NOREPLICAS   â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚  (erreur)      â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â”‚                â”‚      âœ—      â”‚                â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      âœ—      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚  Effet:                                                         â”‚
â”‚  â€¢ Master isolÃ© refuse toutes les Ã©critures                     â”‚
â”‚  â€¢ EmpÃªche les Ã©critures divergentes pendant split-brain        â”‚
â”‚  â€¢ Sentinel de Partition B peut faire failover sans risque      â”‚
â”‚  â€¢ âœ… DonnÃ©es cohÃ©rentes mÃªme en cas de split-brain             â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Timeline complÃ¨te avec protection:                             â”‚
â”‚                                                                 â”‚
â”‚  t=0s:   Master + Replica, tout OK                              â”‚
â”‚  t=30s:  Partition rÃ©seau                                       â”‚
â”‚  t=30s:  Master dÃ©tecte 0 replicas connectÃ©s                    â”‚
â”‚  t=30s:  Master â†’ Mode READ-ONLY (refuse writes)                â”‚
â”‚  t=60s:  Sentinel B fait failover (promeut Replica)             â”‚
â”‚  t=90s:  Nouveau master accepte writes                          â”‚
â”‚  t=120s: RÃ©seau revient                                         â”‚
â”‚  t=120s: Ancien master devient replica (aucune donnÃ©e perdue)   â”‚
â”‚                                                                 â”‚
â”‚  âœ… AUCUNE PERTE DE DONNÃ‰ES!                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Configuration recommandÃ©e** :

```ini
# redis.conf (Master)

# Minimum de replicas connectÃ©s pour accepter writes
# Valeur recommandÃ©e: 1 (si 2+ replicas au total)
min-replicas-to-write 1

# Maximum de lag acceptable (secondes)
# Valeur recommandÃ©e: 10s (Ã©quilibre entre protection et disponibilitÃ©)
min-replicas-max-lag 10

# Note: Si vous avez 3 replicas, vous pouvez mettre:
# min-replicas-to-write 2
# Cela garantit qu'au moins 2 replicas ont les donnÃ©es
# avant de confirmer l'Ã©criture (plus safe, moins disponible)
```

### Protection 2 : Quorum majoritaire

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROTECTION: QUORUM MAJORITAIRE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  RÃ¨gle: Q = (N / 2) + 1  (majoritÃ© stricte)                     â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Exemple: 5 Sentinels rÃ©partis sur 2 datacenters                â”‚
â”‚                                                                 â”‚
â”‚  DC-A (Principal)       â”‚       DC-B (Backup)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Sentinel 1    â”‚     â”‚     â”‚  Sentinel 4    â”‚                â”‚
â”‚  â”‚  Sentinel 2    â”‚     â”‚     â”‚  Sentinel 5    â”‚                â”‚
â”‚  â”‚  Sentinel 3    â”‚     â”‚     â”‚                â”‚                â”‚
â”‚  â”‚                â”‚     â”‚     â”‚                â”‚                â”‚
â”‚  â”‚  (3 Sentinels) â”‚     â”‚     â”‚  (2 Sentinels) â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â”‚  Quorum configurÃ©: 3 (= (5/2) + 1)                              â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  ScÃ©nario 1: Panne DC-A (perd 3 Sentinels)                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚  DC-A DOWN âœ—            â”‚       DC-B (Survit)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Sentinel 1 âœ—  â”‚     â”‚     â”‚  Sentinel 4 âœ… â”‚                â”‚
â”‚  â”‚  Sentinel 2 âœ—  â”‚     â”‚     â”‚  Sentinel 5 âœ… â”‚                â”‚
â”‚  â”‚  Sentinel 3 âœ—  â”‚     â”‚     â”‚                â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚  Sentinels: 2  â”‚                â”‚
â”‚                         â”‚     â”‚  Quorum: 3     â”‚                â”‚
â”‚                         â”‚     â”‚  2 < 3 âŒ      â”‚                â”‚
â”‚                         â”‚     â”‚                â”‚                â”‚
â”‚                         â”‚     â”‚  PAS DE        â”‚                â”‚
â”‚                         â”‚     â”‚  FAILOVER      â”‚                â”‚
â”‚                         â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â”‚  RÃ©sultat: Service interrompu MAIS pas de split-brain           â”‚
â”‚            Intervention manuelle nÃ©cessaire                     â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  ScÃ©nario 2: Panne DC-B (perd 2 Sentinels)                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚  DC-A (Survit)          â”‚       DC-B DOWN âœ—                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Sentinel 1 âœ… â”‚     â”‚     â”‚  Sentinel 4 âœ—  â”‚                â”‚
â”‚  â”‚  Sentinel 2 âœ… â”‚     â”‚     â”‚  Sentinel 5 âœ—  â”‚                â”‚
â”‚  â”‚  Sentinel 3 âœ… â”‚     â”‚     â”‚                â”‚                â”‚
â”‚  â”‚                â”‚     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â”‚  Sentinels: 3  â”‚     â”‚                                       â”‚
â”‚  â”‚  Quorum: 3     â”‚     â”‚                                       â”‚
â”‚  â”‚  3 â‰¥ 3 âœ…      â”‚     â”‚                                       â”‚
â”‚  â”‚                â”‚     â”‚                                       â”‚
â”‚  â”‚  FAILOVER      â”‚     â”‚                                       â”‚
â”‚  â”‚  POSSIBLE      â”‚     â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                                       â”‚
â”‚                                                                 â”‚
â”‚  RÃ©sultat: Failover automatique possible                        â”‚
â”‚            Service maintenu                                     â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  ScÃ©nario 3: Partition rÃ©seau (2 partitions Ã©gales)             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                                 â”‚
â”‚  DC-A (3 Sentinels)     âœ—       DC-B (2 Sentinels)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     âœ—     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  3 Sentinels   â”‚     âœ—     â”‚  2 Sentinels   â”‚                â”‚
â”‚  â”‚  3 â‰¥ 3 âœ…      â”‚     âœ—     â”‚  2 < 3 âŒ      â”‚
â”‚  â”‚                â”‚     âœ—     â”‚                â”‚                â”‚
â”‚  â”‚  Peut faire    â”‚     âœ—     â”‚  NE peut PAS   â”‚                â”‚
â”‚  â”‚  failover      â”‚     âœ—     â”‚  faire failoverâ”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     âœ—     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â”‚  RÃ©sultat:                                                      â”‚
â”‚  â€¢ Seule la partition MAJORITAIRE peut faire failover           â”‚
â”‚  â€¢ âœ… Pas de split-brain (une seule partition peut agir)        â”‚
â”‚  â€¢ RÃ©partition asymÃ©trique intentionnelle (3 vs 2)              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protection 3 : Epoch (Configuration Epoch)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROTECTION: EPOCH (CONFIGURATION VERSIONING)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Epoch = Compteur de version de la configuration                â”‚
â”‚          IncrÃ©mentÃ© Ã  chaque failover                           â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  Timeline avec Epochs:                                          â”‚
â”‚                                                                 â”‚
â”‚  t=0: Configuration initiale                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Master: 10.1.0.10                          â”‚                 â”‚
â”‚  â”‚ Epoch: 0                                   â”‚                 â”‚
â”‚  â”‚ Sentinels: Tous synchronisÃ©s sur epoch 0   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  t=100: Premier failover                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Ancien master: 10.1.0.10 (epoch 0)         â”‚                 â”‚
â”‚  â”‚ Nouveau master: 10.1.0.11 (epoch 1) âœ…     â”‚                 â”‚
â”‚  â”‚ Epoch incrÃ©mentÃ©: 0 â†’ 1                    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  t=200: Partition puis rÃ©unification                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Partition A:                               â”‚                 â”‚
â”‚  â”‚ â€¢ Master A (epoch 1)                       â”‚                 â”‚
â”‚  â”‚ â€¢ Fait un failover â†’ epoch 2               â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚ Partition B:                               â”‚                 â”‚
â”‚  â”‚ â€¢ Master B (epoch 1)                       â”‚                 â”‚
â”‚  â”‚ â€¢ Fait un failover â†’ epoch 2               â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚ âš ï¸  Conflit: 2 masters avec epoch 2        â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  RÃ©solution du conflit par epoch:                               â”‚
â”‚                                                                 â”‚
â”‚  Quand les partitions se rÃ©unifient:                            â”‚
â”‚                                                                 â”‚
â”‚  1. Sentinels Ã©changent leurs configurations                    â”‚
â”‚                                                                 â”‚
â”‚  2. Comparaison des epochs:                                     â”‚
â”‚     Master A: epoch 2, config-epoch: T1                         â”‚
â”‚     Master B: epoch 2, config-epoch: T2                         â”‚
â”‚                                                                 â”‚
â”‚  3. Si epochs identiques, comparer les timestamps:              â”‚
â”‚     â€¢ Config-epoch = timestamp de la config                     â”‚
â”‚     â€¢ Plus rÃ©cent = gagnant                                     â”‚
â”‚                                                                 â”‚
â”‚  4. Master avec config plus ancienne devient replica            â”‚
â”‚                                                                 â”‚
â”‚  Exemple:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Master A:                                  â”‚                 â”‚
â”‚  â”‚ â€¢ epoch: 2                                 â”‚                 â”‚
â”‚  â”‚ â€¢ config-epoch: 1670000000 (timestamp)     â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚ Master B:                                  â”‚                 â”‚
â”‚  â”‚ â€¢ epoch: 2                                 â”‚                 â”‚
â”‚  â”‚ â€¢ config-epoch: 1670000100 (timestamp)     â”‚                 â”‚
â”‚  â”‚                            â†‘               â”‚                 â”‚
â”‚  â”‚                        Plus rÃ©cent âœ…      â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚ RÃ©solution:                                â”‚                 â”‚
â”‚  â”‚ Master B reste master (config plus rÃ©cente)â”‚                 â”‚
â”‚  â”‚ Master A â†’ replica de B                    â”‚                 â”‚
â”‚  â”‚ Master A fait FULLRESYNC (perd ses donnÃ©es)â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚  âœ… Conflict rÃ©solu automatiquement                             â”‚
â”‚  âŒ Mais: perte des donnÃ©es de la partition perdante            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Configurations Anti-Split-Brain

### Configuration Optimale : DÃ©ploiement 3 AZ

```ini
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION OPTIMALE ANTI-SPLIT-BRAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Environnement: 3 Availability Zones
# Total: 3 Sentinels, 1 Master, 2 Replicas
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# REDIS MASTER (AZ-A: 10.0.1.10)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# redis-master.conf
port 6379
bind 10.0.1.10 127.0.0.1
requirepass "MasterPass123!"
masterauth "MasterPass123!"

# CRITIQUE: Protection split-brain
min-replicas-to-write 1      # âœ… Au moins 1 replica
min-replicas-max-lag 10      # âœ… Avec <10s de lag

# Si master isolÃ© (0 replicas), il refuse writes
# EmpÃªche donnÃ©es divergentes pendant partition

appendonly yes
save ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# REDIS REPLICA 1 (AZ-B: 10.0.1.11)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# redis-replica1.conf
port 6379
bind 10.0.1.11 127.0.0.1
requirepass "ReplicaPass123!"
masterauth "MasterPass123!"

replicaof 10.0.1.10 6379
replica-read-only yes
replica-priority 100         # âœ… PrioritÃ© normale

appendonly yes

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# REDIS REPLICA 2 (AZ-C: 10.0.1.12)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# redis-replica2.conf
port 6379
bind 10.0.1.12 127.0.0.1
requirepass "ReplicaPass123!"
masterauth "MasterPass123!"

replicaof 10.0.1.10 6379
replica-read-only yes
replica-priority 90          # âœ… PrioritÃ© lÃ©gÃ¨rement plus haute

appendonly yes

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SENTINEL 1 (AZ-A: 10.0.1.20)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# sentinel1.conf
port 26379
bind 10.0.1.20 127.0.0.1
dir /var/lib/redis/sentinel

# CRITIQUE: Quorum = 2 (majoritÃ© de 3)
sentinel monitor mymaster 10.0.1.10 6379 2
#                                        â†‘
#                            Q = (3/2)+1 = 2 âœ…

sentinel auth-pass mymaster MasterPass123!
sentinel down-after-milliseconds mymaster 30000
sentinel failover-timeout mymaster 180000
sentinel parallel-syncs mymaster 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SENTINEL 2 (AZ-B: 10.0.1.21)
# SENTINEL 3 (AZ-C: 10.0.1.22)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Configurations identiques Ã  Sentinel 1
# (changer bind IP)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ANALYSE DE RÃ‰SILIENCE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ScÃ©nario 1: Panne AZ-A (Master + Sentinel1)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â€¢ Sentinels actifs: 2 (AZ-B, AZ-C)
# â€¢ Quorum: 2
# â€¢ 2 â‰¥ 2 âœ… â†’ Failover possible
# â€¢ Replica1 ou Replica2 promu master
# â€¢ âœ… Service maintenu

# ScÃ©nario 2: Panne AZ-A + AZ-B
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â€¢ Sentinels actifs: 1 (AZ-C)
# â€¢ Quorum: 2
# â€¢ 1 < 2 âŒ â†’ Failover impossible
# â€¢ Service interrompu
# â€¢ âœ… Mais pas de split-brain

# ScÃ©nario 3: Partition rÃ©seau (AZ-A isolÃ© de AZ-B+AZ-C)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Partition 1 (AZ-A):
# â€¢ Master: DÃ©tecte 0 replicas â†’ REFUSE writes âœ…
# â€¢ Sentinel: 1 < quorum 2 â†’ Pas de failover
#
# Partition 2 (AZ-B + AZ-C):
# â€¢ Sentinels: 2 â‰¥ quorum 2 â†’ Failover possible âœ…
# â€¢ Replica promu â†’ Nouveau master
# â€¢ Nouveau master accepte writes
#
# RÃ©sultat:
# âœ… Pas de split-brain
# âœ… Partition majoritaire reste opÃ©rationnelle
# âœ… Aucune perte de donnÃ©es

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Configuration Advanced : DÃ©ploiement Multi-DC

```ini
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION MULTI-DATACENTER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DC-A (Principal): 3 Sentinels
# DC-B (Backup):    2 Sentinels
# Total: 5 Sentinels, Quorum = 3
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SENTINELS DC-A (10.1.0.20, 10.1.0.21, 10.1.0.22)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# sentinel-dc-a.conf
port 26379
bind <sentinel_ip> 127.0.0.1
dir /var/lib/redis/sentinel

# CRITIQUE: Quorum = 3 (majoritÃ© de 5)
sentinel monitor mymaster 10.1.0.10 6379 3
#                                        â†‘
#                            Q = (5/2)+1 = 3 âœ…

sentinel auth-pass mymaster MasterPass123!
sentinel down-after-milliseconds mymaster 30000
sentinel failover-timeout mymaster 180000
sentinel parallel-syncs mymaster 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SENTINELS DC-B (10.2.0.20, 10.2.0.21)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Configuration identique (changer bind IP)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ANALYSE DE RÃ‰SILIENCE MULTI-DC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ScÃ©nario 1: Panne DC-A complet (perd 3 Sentinels)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â€¢ Sentinels actifs: 2 (DC-B)
# â€¢ Quorum: 3
# â€¢ 2 < 3 âŒ â†’ Failover impossible
# â€¢ âœ… Pas de split-brain
# â€¢ âŒ Service interrompu (nÃ©cessite intervention manuelle)

# ScÃ©nario 2: Panne DC-B complet (perd 2 Sentinels)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â€¢ Sentinels actifs: 3 (DC-A)
# â€¢ Quorum: 3
# â€¢ 3 â‰¥ 3 âœ… â†’ Failover possible
# â€¢ âœ… Service maintenu

# ScÃ©nario 3: Partition WAN (DC-A â†” DC-B coupÃ©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Partition DC-A:
# â€¢ 3 Sentinels, quorum 3
# â€¢ 3 â‰¥ 3 âœ… â†’ Peut faire failover
#
# Partition DC-B:
# â€¢ 2 Sentinels, quorum 3
# â€¢ 2 < 3 âŒ â†’ Ne peut PAS faire failover
#
# RÃ©sultat:
# âœ… Seul DC-A (majoritaire) peut agir
# âœ… Pas de split-brain

# RÃ©partition asymÃ©trique (3 vs 2) intentionnelle:
# â€¢ Garantit qu'une seule partition peut faire failover
# â€¢ DC principal garde le contrÃ´le
# â€¢ Compromis: panne DC principal = downtime

# Alternative avec rÃ©partition 3-3-1 (3 DCs):
# â€¢ DC-A: 3 Sentinels
# â€¢ DC-B: 3 Sentinels
# â€¢ DC-C: 1 Sentinel (tiebreaker)
# â€¢ Total: 7, Quorum: 4
# â€¢ TolÃ¨re panne 1 DC complet

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ” DÃ©tection et Monitoring du Split-Brain

### Indicateurs de risque

```bash
#!/bin/bash
# detect-splitbrain-risk.sh

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Split-Brain Risk Assessment"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

SENTINEL_HOSTS=("10.0.1.20" "10.0.1.21" "10.0.1.22")
SENTINEL_PORT="26379"
MASTER_NAME="mymaster"

# Couleurs
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

risk_high() {
    echo -e "${RED}ğŸ”´ HIGH RISK${NC}: $1"
}

risk_medium() {
    echo -e "${YELLOW}ğŸŸ¡ MEDIUM RISK${NC}: $1"
}

risk_low() {
    echo -e "${GREEN}ğŸŸ¢ LOW RISK${NC}: $1"
}

# 1. VÃ©rifier nombre de Sentinels actifs
echo ""
echo "1. Sentinel Availability"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ACTIVE_SENTINELS=0
for host in "${SENTINEL_HOSTS[@]}"; do
    if redis-cli -h $host -p $SENTINEL_PORT PING >/dev/null 2>&1; then
        ACTIVE_SENTINELS=$((ACTIVE_SENTINELS + 1))
        echo "  $host: âœ… Active"
    else
        echo "  $host: âŒ Unreachable"
    fi
done

TOTAL_SENTINELS=${#SENTINEL_HOSTS[@]}
echo ""
echo "Active Sentinels: $ACTIVE_SENTINELS / $TOTAL_SENTINELS"

if [ $ACTIVE_SENTINELS -lt 3 ]; then
    risk_high "Less than 3 Sentinels active"
elif [ $ACTIVE_SENTINELS -eq 3 ]; then
    risk_low "All Sentinels active"
else
    risk_low "$ACTIVE_SENTINELS Sentinels active"
fi

# 2. VÃ©rifier quorum configuration
echo ""
echo "2. Quorum Configuration"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
FIRST_ACTIVE=""
for host in "${SENTINEL_HOSTS[@]}"; do
    if redis-cli -h $host -p $SENTINEL_PORT PING >/dev/null 2>&1; then
        FIRST_ACTIVE=$host
        break
    fi
done

if [ -n "$FIRST_ACTIVE" ]; then
    QUORUM=$(redis-cli -h $FIRST_ACTIVE -p $SENTINEL_PORT SENTINEL master $MASTER_NAME | grep -A1 "^quorum$" | tail -n1)
    EXPECTED_QUORUM=$(( ($TOTAL_SENTINELS / 2) + 1 ))

    echo "Configured Quorum: $QUORUM"
    echo "Expected Quorum: $EXPECTED_QUORUM"

    if [ "$QUORUM" -lt "$EXPECTED_QUORUM" ]; then
        risk_high "Quorum too low ($QUORUM < $EXPECTED_QUORUM) - Split-brain possible!"
    elif [ "$QUORUM" -gt "$EXPECTED_QUORUM" ]; then
        risk_medium "Quorum too high ($QUORUM > $EXPECTED_QUORUM) - May prevent failover"
    else
        risk_low "Quorum optimal ($QUORUM)"
    fi

    # VÃ©rifier si quorum atteignable
    if [ $ACTIVE_SENTINELS -lt $QUORUM ]; then
        risk_high "Active Sentinels ($ACTIVE_SENTINELS) < Quorum ($QUORUM) - Cannot reach consensus!"
    fi
fi

# 3. VÃ©rifier min-replicas-to-write sur master
echo ""
echo "3. Master Split-Brain Protection"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
MASTER_ADDR=$(redis-cli -h $FIRST_ACTIVE -p $SENTINEL_PORT SENTINEL get-master-addr-by-name $MASTER_NAME)
MASTER_IP=$(echo "$MASTER_ADDR" | head -n1)
MASTER_PORT=$(echo "$MASTER_ADDR" | tail -n1)

if [ -n "$MASTER_IP" ]; then
    MIN_REPLICAS=$(redis-cli -h $MASTER_IP -p $MASTER_PORT -a "$REDIS_PASSWORD" CONFIG GET min-replicas-to-write 2>/dev/null | tail -n1)

    echo "Master: $MASTER_IP:$MASTER_PORT"
    echo "min-replicas-to-write: $MIN_REPLICAS"

    if [ "$MIN_REPLICAS" -eq 0 ]; then
        risk_high "min-replicas-to-write = 0 - No split-brain protection!"
    elif [ "$MIN_REPLICAS" -ge 1 ]; then
        risk_low "min-replicas-to-write = $MIN_REPLICAS âœ…"
    fi
fi

# 4. VÃ©rifier nombre de replicas connectÃ©s
echo ""
echo "4. Replica Connectivity"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -n "$MASTER_IP" ]; then
    CONNECTED_REPLICAS=$(redis-cli -h $MASTER_IP -p $MASTER_PORT -a "$REDIS_PASSWORD" INFO replication 2>/dev/null | grep "connected_slaves:" | cut -d: -f2 | tr -d '\r')

    echo "Connected Replicas: $CONNECTED_REPLICAS"

    if [ "$CONNECTED_REPLICAS" -eq 0 ]; then
        risk_high "No replicas connected - Master isolated!"
    elif [ "$CONNECTED_REPLICAS" -ge 2 ]; then
        risk_low "$CONNECTED_REPLICAS replicas connected"
    else
        risk_medium "Only $CONNECTED_REPLICAS replica connected"
    fi
fi

# 5. VÃ©rifier epochs (dÃ©tection de conflits passÃ©s)
echo ""
echo "5. Epoch Consistency"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
declare -A EPOCHS
for host in "${SENTINEL_HOSTS[@]}"; do
    if redis-cli -h $host -p $SENTINEL_PORT PING >/dev/null 2>&1; then
        EPOCH=$(redis-cli -h $host -p $SENTINEL_PORT SENTINEL master $MASTER_NAME 2>/dev/null | grep -A1 "^config-epoch$" | tail -n1)
        EPOCHS[$host]=$EPOCH
        echo "  $host: epoch $EPOCH"
    fi
done

# VÃ©rifier si tous ont le mÃªme epoch
UNIQUE_EPOCHS=$(printf '%s\n' "${EPOCHS[@]}" | sort -u | wc -l)
if [ "$UNIQUE_EPOCHS" -gt 1 ]; then
    risk_medium "Sentinels have different epochs - Recent split or still converging"
else
    risk_low "All Sentinels synchronized on same epoch"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Assessment Complete"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
```

### Alertes critiques Prometheus

```yaml
# prometheus-alerts.yml

groups:
  - name: redis_splitbrain_protection
    interval: 30s
    rules:
      # Alerte 1: Quorum mal configurÃ©
      - alert: RedisQuorumMisconfigured
        expr: |
          redis_sentinel_quorum < (redis_sentinel_known_sentinels / 2) + 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Redis Sentinel quorum misconfigured"
          description: "Quorum {{ $value }} is too low, should be at least {{ $expected }}. Split-brain risk!"

      # Alerte 2: Pas assez de Sentinels actifs
      - alert: RedisInsufficientSentinels
        expr: |
          redis_sentinel_sentinels < 3
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Insufficient active Sentinels"
          description: "Only {{ $value }} Sentinels active (minimum: 3)"

      # Alerte 3: Quorum non atteignable
      - alert: RedisQuorumUnreachable
        expr: |
          redis_sentinel_sentinels < redis_sentinel_quorum
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis quorum unreachable"
          description: "Active Sentinels ({{ $value }}) < Quorum. Cannot perform failover!"

      # Alerte 4: Master sans protection split-brain
      - alert: RedisMasterNoSplitBrainProtection
        expr: |
          redis_config_min_replicas_to_write == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Redis master has no split-brain protection"
          description: "min-replicas-to-write is 0 on master {{ $labels.instance }}"

      # Alerte 5: Master isolÃ© (aucun replica)
      - alert: RedisMasterIsolated
        expr: |
          redis_connected_slaves == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Redis master isolated"
          description: "Master {{ $labels.instance }} has no connected replicas"

      # Alerte 6: Epochs divergents (possible split-brain passÃ©)
        - alert: RedisSentinelEpochDivergence
        expr: |
          count(count by (config_epoch) (redis_sentinel_master_config_epoch)) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis Sentinels have divergent epochs"
          description: "Different config epochs detected, possible past split-brain"
```

---

## ğŸ“ Points clÃ©s Ã  retenir

1. **Split-brain = danger maximum** : Plusieurs masters â†’ donnÃ©es divergentes irrÃ©versibles
2. **Quorum = (N/2) + 1** : Toujours majoritÃ© stricte, nombre impair de Sentinels
3. **min-replicas-to-write â‰¥ 1** : Protection critique cÃ´tÃ© master
4. **RÃ©partition asymÃ©trique** : Multi-DC avec plus de Sentinels sur site principal
5. **Epoch rÃ©sout conflits** : Automatiquement, mais avec perte de donnÃ©es
6. **Monitoring continu** : DÃ©tecter risques avant qu'ils ne se matÃ©rialisent
7. **Tests rÃ©guliers** : Simuler partitions rÃ©seau en pre-prod
8. **Documentation** : ProcÃ©dures de rÃ©cupÃ©ration post-split-brain
9. **Alerting agressif** : Quorum non atteignable = alerte critique immÃ©diate
10. **Trade-off disponibilitÃ©/cohÃ©rence** : Accepter downtime plutÃ´t que split-brain

---

## ğŸ”— RÃ©fÃ©rences

- [Redis Sentinel Internals](https://redis.io/topics/sentinel)
- [CAP Theorem](https://en.wikipedia.org/wiki/CAP_theorem)
- [Raft Consensus Algorithm](https://raft.github.io/) (similaire au mÃ©canisme Sentinel)

---

**Section suivante** : [10.6 Connexion des clients via Sentinel (Service Discovery)](./06-connexion-clients-sentinel.md)

â­ï¸ [Connexion des clients via Sentinel (Service Discovery)](/10-architecture-haute-disponibilite/06-connexion-clients-sentinel.md)
